<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrderBot - Intelligent Document Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- SheetJS for Excel Support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' } // Custom dark shades
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.2s ease-in-out;
            min-height: 140px;
        }
        .dark .drop-zone { border-color: #475569; background-color: #1e293b; }
        .drop-zone.drag-over { background-color: #e2e8f0; border-color: #4f46e5; }
        .dark .drop-zone.drag-over { background-color: #334155; border-color: #6366f1; }

        .file-preview-item {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .dark .file-preview-item { border-color: #475569; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Interactive Elements */
        .reportable-cell { cursor: pointer; transition: background-color 0.2s; }
        .reportable-cell:hover { background-color: #eff6ff; }
        .dark .reportable-cell:hover { background-color: #1e293b; }

        /* Confidence Bar */
        .confidence-track { height: 4px; width: 100%; background-color: #e2e8f0; border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .dark .confidence-track { background-color: #334155; }
        .confidence-fill { height: 100%; transition: width 0.5s ease-out; }

        /* Tabs */
        .tab-btn.active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .dark .tab-btn.active { border-bottom-color: #818cf8; color: #818cf8; }

        /* Diff View */
        .diff-highlight-red { background-color: #fee2e2; color: #991b1b; padding: 0 2px; border-radius: 2px; }
        .diff-highlight-green { background-color: #dcfce7; color: #166534; padding: 0 2px; border-radius: 2px; }
        .dark .diff-highlight-red { background-color: #7f1d1d; color: #fecaca; }
        .dark .diff-highlight-green { background-color: #14532d; color: #bbf7d0; }

        .tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background-color: #1e293b; color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 0.75rem; white-space: nowrap; opacity: 0; visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s; z-index: 10;
        }
        .reportable-cell:hover .tooltip, .spec-text:hover .tooltip { opacity: 1; visibility: visible; }

        /* Collapsible Section Styles */
        .collapsible-content {
            /* No max-height needed for simple toggle */
        }
        .chevron-icon {
            transition: transform 0.3s ease-out;
        }
        .open .chevron-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 min-h-screen flex flex-col">

    <div class="container mx-auto p-4 md:p-6 max-w-7xl flex-grow">
        <!-- Header -->
        <header class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm mb-6 flex flex-wrap items-center justify-between gap-4 transition-colors duration-300">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                    <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">OrderBot</h1>
                    <p class="text-xs text-slate-500 dark:text-slate-400 tracking-wide">INTELLIGENT COMPARISON ENGINE</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <!-- Theme Toggle -->
                <button id="theme-toggle" class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
                    <!-- Sun Icon -->
                    <svg class="w-5 h-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <!-- Moon Icon -->
                    <svg class="w-5 h-5 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6 space-x-6 overflow-x-auto">
            <button class="tab-btn active pb-3 text-sm transition-colors whitespace-nowrap" data-tab="upload">Upload & Compare</button>
            <button class="tab-btn pb-3 text-sm text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors whitespace-nowrap" data-tab="rules">Rule Builder</button>
            <button class="tab-btn pb-3 text-sm text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors whitespace-nowrap" data-tab="analytics">Dashboard</button>
            <button class="tab-btn pb-3 text-sm text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors whitespace-nowrap" data-tab="properties">Properties</button>
        </div>

        <!-- TAB CONTENT: UPLOAD -->
        <div id="tab-upload" class="tab-content fade-in">
            <div id="upload-section">
                <div id="upload-pairs-container" class="space-y-4">
                    <!-- Dynamic Pair Template will be injected here -->
                </div>
                
                <div class="mt-6 flex justify-center gap-4">
                    <button id="add-pair-btn" class="flex items-center gap-2 px-6 py-3 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-semibold rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                        Add Another Order
                    </button>
                </div>

                <div class="text-center mt-8 mb-12">
                    <button id="compare-btn" class="px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-lg rounded-xl shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:-translate-y-0.5" disabled>
                        Run Intelligent Comparison
                    </button>
                </div>
            </div>

            <!-- Report Section (Hidden by default) -->
            <div id="report-section" class="hidden bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
                <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Comparison Report</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Review discrepancies below.</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="export-pdf-btn" class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg font-medium hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Export PDF
                        </button>
                        <button id="new-comparison-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                            Start New
                        </button>
                    </div>
                </div>
                <div id="report-content" class="p-6 bg-slate-50 dark:bg-slate-900/50 min-h-[300px]"></div>
            </div>
        </div>

        <!-- TAB CONTENT: RULES (COMPLEX) -->
        <div id="tab-rules" class="tab-content hidden fade-in">
            <div class="grid lg:grid-cols-3 gap-8">
                <!-- Rule Builder Form -->
                <div class="lg:col-span-1 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 h-fit sticky top-4">
                    <h3 class="text-lg font-bold mb-4 text-slate-800 dark:text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                        Complex Logic Builder
                    </h3>
                    
                    <!-- Dynamic Conditions Container -->
                    <div id="rule-conditions-container" class="space-y-3 mb-4">
                        <!-- Rows will be injected here -->
                    </div>
                    
                    <button id="add-condition-btn" class="w-full py-2 border-2 border-dashed border-indigo-200 dark:border-slate-600 text-indigo-600 dark:text-indigo-400 rounded-lg font-semibold text-sm hover:bg-indigo-50 dark:hover:bg-slate-700 transition-colors mb-4">+ Add Condition (AND/OR)</button>

                    <div>
                        <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 uppercase mb-1">Then Requirement</label>
                        <textarea id="rule-requirement" rows="3" class="w-full p-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-sm" placeholder="e.g. Tube must be 55mm"></textarea>
                    </div>
                    <div class="mt-4">
                         <button id="save-complex-rule-btn" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold text-sm transition-colors">Save Rule</button>
                    </div>
                </div>

                <!-- Active Rules List -->
                <div class="lg:col-span-2 space-y-4">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                        <h3 class="text-lg font-bold mb-4 text-slate-800 dark:text-white">Active Logic Rules</h3>
                        <div id="rules-container" class="space-y-3">
                            <!-- Rules injected here -->
                            <div class="text-center py-8 text-slate-400 dark:text-slate-500 italic">No custom logic rules defined yet.</div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                         <h3 class="text-lg font-bold mb-4 text-slate-800 dark:text-white">Text Guidelines (Simple)</h3>
                         <div class="flex gap-2 mb-4">
                             <input type="text" id="legacy-guideline-input" class="flex-grow p-2 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg text-sm" placeholder="Add a free-text guideline...">
                             <button id="add-legacy-guideline-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-medium rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600">Add</button>
                         </div>
                         <div id="guidelines-list" class="space-y-2 text-sm"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB CONTENT: ANALYTICS -->
        <div id="tab-analytics" class="tab-content hidden fade-in">
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="text-lg font-bold mb-4 text-slate-800 dark:text-white">Discrepancy Trends</h3>
                    <div class="h-64 relative">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="text-lg font-bold mb-4 text-slate-800 dark:text-white">Error Distribution by Field</h3>
                    <div class="h-64 relative">
                         <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Comparison History Search -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-800 dark:text-white">Historical Reports</h3>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="history-search-input" class="flex-grow p-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg" placeholder="Search by Order Number...">
                    <button id="history-search-btn" class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">Search</button>
                </div>
                <div id="history-results" class="space-y-3"></div>
            </div>
        </div>

        <!-- TAB CONTENT: PROPERTIES -->
        <div id="tab-properties" class="tab-content hidden fade-in space-y-6">
             <!-- Fabric Properties Section -->
            <div id="fabric-properties-section" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm overflow-hidden border border-slate-200 dark:border-slate-700">
                <div id="fabric-properties-header" class="flex justify-between items-center p-4 cursor-pointer bg-slate-50 dark:bg-slate-900/50">
                    <h3 class="font-bold text-lg text-slate-800 dark:text-white">Fabric Properties</h3>
                    <svg class="chevron-icon w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
                 <div id="fabric-properties-content" class="collapsible-content hidden">
                    <div class="p-4">
                         <label id="fabric-csv-drop-zone" class="drop-zone !min-h-[80px] p-4 mb-3 rounded-lg flex flex-col items-center justify-center cursor-pointer text-center border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-500 dark:hover:border-indigo-500">
                            <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Upload CSV to Replace All</h3>
                            <input type="file" id="fabric-csv-upload" class="hidden" accept=".csv">
                        </label>
                        
                        <!-- Header Row for Fabrics -->
                        <div class="grid gap-2 px-2 py-1 mb-1 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider" style="grid-template-columns: 2fr 1fr 1fr 1fr auto;">
                            <div>Fabric Name</div>
                            <div>Weight (kg/mÂ²)</div>
                            <div>Max Width</div>
                            <div>Turnable?</div>
                            <div class="text-right">Action</div>
                        </div>

                        <div id="fabric-properties-list" class="space-y-2 max-h-60 overflow-y-auto mb-3"></div>
                         <button id="add-fabric-btn" class="w-full py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors text-sm">Add New Fabric</button>
                    </div>
                </div>
            </div>
            
            <!-- Motor Properties Section -->
            <div id="motor-properties-section" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm overflow-hidden border border-slate-200 dark:border-slate-700">
                <div id="motor-properties-header" class="flex justify-between items-center p-4 cursor-pointer bg-slate-50 dark:bg-slate-900/50">
                     <h3 class="font-bold text-lg text-slate-800 dark:text-white">Motor Properties</h3>
                     <svg class="chevron-icon w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
                <div id="motor-properties-content" class="collapsible-content hidden">
                     <div class="p-4">
                        <label id="motor-csv-drop-zone" class="drop-zone !min-h-[80px] p-4 mb-3 rounded-lg flex flex-col items-center justify-center cursor-pointer text-center border-2 border-dashed border-slate-300 dark:border-slate-600">
                            <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Upload CSV</h3>
                            <input type="file" id="motor-csv-upload" class="hidden" accept=".csv">
                        </label>

                        <!-- Header Row for Motors -->
                        <div class="grid gap-2 px-2 py-1 mb-1 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider" style="grid-template-columns: repeat(8, 1fr) auto;">
                            <div>Name</div>
                            <div>Torque</div>
                            <div>Type</div>
                            <div>Adapter</div>
                            <div>Acc.</div>
                            <div>Deps</div>
                            <div>Control</div>
                            <div>Options</div>
                            <div class="text-right">Act</div>
                        </div>

                        <div id="motor-properties-list" class="space-y-2 max-h-60 overflow-y-auto mb-3"></div>
                        <button id="add-motor-btn" class="w-full py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors text-sm">Add New Motor</button>
                     </div>
                </div>
            </div>
            
            <!-- Tube Properties Section -->
             <div id="tube-properties-section" class="bg-white dark:bg-slate-800 rounded-xl shadow-sm overflow-hidden border border-slate-200 dark:border-slate-700">
                <div id="tube-properties-header" class="flex justify-between items-center p-4 cursor-pointer bg-slate-50 dark:bg-slate-900/50">
                     <h3 class="font-bold text-lg text-slate-800 dark:text-white">Tube Properties</h3>
                     <svg class="chevron-icon w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
                <div id="tube-properties-content" class="collapsible-content hidden">
                     <div class="p-4">
                        <label id="tube-csv-drop-zone" class="drop-zone !min-h-[80px] p-4 mb-3 rounded-lg flex flex-col items-center justify-center cursor-pointer text-center border-2 border-dashed border-slate-300 dark:border-slate-600">
                            <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Upload CSV</h3>
                            <input type="file" id="tube-csv-upload" class="hidden" accept=".csv">
                        </label>

                        <!-- Header Row for Tubes -->
                        <div class="grid gap-2 px-2 py-1 mb-1 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider" style="grid-template-columns: 2fr 1fr auto;">
                            <div>Blind Type</div>
                            <div>Tube Diameter (mm)</div>
                            <div class="text-right">Action</div>
                        </div>

                        <div id="tube-properties-list" class="space-y-2 max-h-60 overflow-y-auto mb-3"></div>
                        <button id="add-tube-btn" class="w-full py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors text-sm">Add New Tube</button>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Feedback Modal -->
    <!-- UPDATE: Changed z-index from z-50 to z-[60] to ensure it appears over the history modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-black/50 z-[60] hidden items-center justify-center p-4 backdrop-blur-sm">
         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg">
            <div class="p-6 border-b border-slate-200 dark:border-slate-700"><h3 id="feedback-modal-title" class="text-xl font-bold text-slate-800 dark:text-white">Report Error</h3></div>
            <div class="p-6 space-y-4">
                <div class="bg-slate-100 dark:bg-slate-900 p-4 rounded-lg font-mono text-xs text-slate-700 dark:text-slate-300 overflow-x-auto" id="incorrect-item-details"></div>
                 <div id="feedback-textarea-container" class="relative">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Correct Interpretation (Paste image to attach)</label>
                    <div id="feedback-image-container" class="hidden absolute top-9 left-2 z-10"><img id="feedback-image-preview" class="h-12 w-12 object-cover rounded border dark:border-slate-600"><button id="feedback-image-delete" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">&times;</button></div>
                    <textarea id="feedback-explanation" rows="4" class="w-full p-3 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:text-white transition-all" placeholder="Explain the error..."></textarea>
                </div>
            </div>
             <div class="p-6 bg-slate-50 dark:bg-slate-900/50 rounded-b-xl flex justify-end gap-3">
                <button id="cancel-feedback-btn" class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">Cancel</button>
                <button id="submit-feedback-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">Submit</button>
            </div>
         </div>
    </div>

    <!-- Side-by-Side Diff Modal -->
    <div id="diff-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-6xl h-[90vh] flex flex-col">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                 <h3 class="text-xl font-bold text-slate-800 dark:text-white">Visual Verification</h3>
                 <button id="close-diff-btn" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="flex-grow flex overflow-hidden">
                 <!-- Left: Customer Doc (Simulated) -->
                <div class="w-1/2 p-4 border-r border-slate-200 dark:border-slate-700 overflow-y-auto bg-slate-100 dark:bg-slate-900 flex items-center justify-center">
                    <div class="text-center text-slate-500">
                        <p class="mb-2">Document Preview</p>
                        <div class="text-xs">(In a real app, the PDF/Image would render here with bounding boxes)</div>
                    </div>
                </div>
                <!-- Right: Comparison Data -->
                <div class="w-1/2 p-4 overflow-y-auto bg-white dark:bg-slate-800" id="diff-content">
                    <!-- Content injected via JS -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- History Report Modal -->
    <div id="history-report-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col transform transition-all scale-100 opacity-100">
            <div class="p-6 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white" id="history-modal-title">Historical Report</h3>
                    <p class="text-xs text-slate-500 dark:text-slate-400" id="history-modal-subtitle">View past comparison details</p>
                </div>
                <button id="close-history-btn" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto bg-slate-50 dark:bg-slate-900/50 flex-grow" id="history-report-content">
                <!-- Report content injected here -->
            </div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-end bg-white dark:bg-slate-800 rounded-b-xl">
                <button id="close-history-footer-btn" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4 backdrop-blur-sm">
         <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2" id="confirm-modal-title">Are you sure?</h3>
            <p class="text-slate-500 dark:text-slate-400 mb-6" id="confirm-modal-body">Action cannot be undone.</p>
            <div class="flex justify-center gap-3">
                <button id="confirm-modal-cancel" class="px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg">Cancel</button>
                <button id="confirm-modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
            </div>
         </div>
    </div>

    <!-- Upload Pair Template -->
    <template id="upload-pair-template">
        <div class="upload-pair bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 group transition-all hover:shadow-md">
            <div class="flex justify-between items-center mb-4">
                 <h4 class="font-semibold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider pair-label">Order Pair</h4>
                 <div class="cursor-move text-slate-300 hover:text-slate-500 handle"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" /></svg></div>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="drop-zone rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-500 dark:hover:border-indigo-500 bg-slate-50 dark:bg-slate-900/50">
                    <input type="file" class="hidden customer-file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls">
                    <div class="text-center empty-state">
                         <span class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Customer Order</span>
                         <span class="text-xs text-slate-400">Drop PDF, Excel or Image</span>
                    </div>
                    <div class="file-list w-full grid grid-cols-4 gap-2 mt-2"></div>
                </div>
                <div class="drop-zone rounded-xl p-4 flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-slate-300 dark:border-slate-600 hover:border-indigo-500 dark:hover:border-indigo-500 bg-slate-50 dark:bg-slate-900/50">
                    <input type="file" class="hidden blindiq-file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.xlsx,.xls">
                     <div class="text-center empty-state">
                         <span class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Blind IQ Order</span>
                         <span class="text-xs text-slate-400">Drop PDF, Excel or Image</span>
                    </div>
                    <div class="file-list w-full grid grid-cols-4 gap-2 mt-2"></div>
                </div>
            </div>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, writeBatch, getDoc, setDoc, updateDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB3x__sOsj8EPS9KnpweD6uWIhVt9ACNBM",
            authDomain: "orderbot-2b212.firebaseapp.com",
            projectId: "orderbot-2b212",
            storageBucket: "orderbot-2b212.firebasestorage.app",
            messagingSenderId: "51064902388",
            appId: "1:51064902388:web:20d2d93c682a537ebc04a1",
            measurementId: "G-5RM4TC6BD6"
        };
        const PROXY_API_URL = 'https://gemini-secure-proxy-51064902388.africa-south1.run.app';
        
        // --- CONSTANTS ---
        const COMPARISON_MODEL = 'gemini-3-pro-preview';
        const UTILITY_MODEL = 'gemini-2.5-flash';

        const BLIND_TYPE_EXCLUSIONS_FOR_COLOUR_CHECK = [
            'element double roller',
            'curtain glide curtain ripple',
            'curtain somfy',
            'curtain motion'
        ];

        const BLIND_TYPES_REQUIRING_CONTROL_VALIDATION = [
            'element roller',
            'roller system 40',
            'roller system 55',
            'element vison',
            'vision blind',
            'romashade',
            'outdoor channel x',
            'outdoor free hang',
            'outdoor zip x',
            'outdoor wire x',
            'outdoor widescreen'
        ];

        // --- INITIALIZATION ---
        let app, db, auth, userId;
        let comparisonPairs = [];
        let itemToCorrect = null, pastedImageB64 = null;
        let summaryResultsCache = [];
        let fetchedHistoryData = [];

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            userId = auth.currentUser?.uid;
            console.log("Initialized OrderBot. UID:", userId);
        } catch (error) {
            console.error("Init Error:", error);
        }

        // --- DOM ELEMENTS ---
        const el = {
            uploadPairsContainer: document.getElementById('upload-pairs-container'),
            addPairBtn: document.getElementById('add-pair-btn'),
            compareBtn: document.getElementById('compare-btn'),
            reportSection: document.getElementById('report-section'),
            reportContent: document.getElementById('report-content'),
            themeToggle: document.getElementById('theme-toggle'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            tabContents: document.querySelectorAll('.tab-content'),
            
            feedbackModal: document.getElementById('feedback-modal'),
            feedbackTextarea: document.getElementById('feedback-explanation'),
            
            diffModal: document.getElementById('diff-modal'),
            closeDiffBtn: document.getElementById('close-diff-btn'),
            diffContent: document.getElementById('diff-content'),
            
            // Rule Builder Elements
            ruleConditionsContainer: document.getElementById('rule-conditions-container'),
            addConditionBtn: document.getElementById('add-condition-btn'),
            ruleRequirement: document.getElementById('rule-requirement'),
            saveComplexRuleBtn: document.getElementById('save-complex-rule-btn'),
            rulesContainer: document.getElementById('rules-container'),
            legacyGuidelineInput: document.getElementById('legacy-guideline-input'),
            addLegacyGuidelineBtn: document.getElementById('add-legacy-guideline-btn'),
            
            // Analytics
            trendChartCtx: document.getElementById('trendChart').getContext('2d'),
            distributionChartCtx: document.getElementById('distributionChart').getContext('2d'),
            
             // Properties
            fabricHeader: document.getElementById('fabric-properties-header'),
            fabricContent: document.getElementById('fabric-properties-content'),
            fabricPropertiesList: document.getElementById('fabric-properties-list'),
            fabricCsvUpload: document.getElementById('fabric-csv-upload'),
            fabricCsvDropZone: document.getElementById('fabric-csv-drop-zone'),
            addFabricBtn: document.getElementById('add-fabric-btn'),

            motorHeader: document.getElementById('motor-properties-header'),
            motorContent: document.getElementById('motor-properties-content'),
            motorPropertiesList: document.getElementById('motor-properties-list'),
            motorCsvUpload: document.getElementById('motor-csv-upload'),
            motorCsvDropZone: document.getElementById('motor-csv-drop-zone'),
            addMotorBtn: document.getElementById('add-motor-btn'),
            
            tubeHeader: document.getElementById('tube-properties-header'),
            tubeContent: document.getElementById('tube-properties-content'),
            tubePropertiesList: document.getElementById('tube-properties-list'),
            tubeCsvUpload: document.getElementById('tube-csv-upload'),
            tubeCsvDropZone: document.getElementById('tube-csv-drop-zone'),
            addTubeBtn: document.getElementById('add-tube-btn'),
            
            exportPdfBtn: document.getElementById('export-pdf-btn'),
            newComparisonBtn: document.getElementById('new-comparison-btn'),
            
            confirmModal: document.getElementById('confirm-modal'),
            confirmModalTitle: document.getElementById('confirm-modal-title'),
            confirmModalBody: document.getElementById('confirm-modal-body'),
            confirmModalCancel: document.getElementById('confirm-modal-cancel'),
            confirmModalConfirm: document.getElementById('confirm-modal-confirm'),
            
            feedbackModalTitle: document.getElementById('feedback-modal-title'),
            incorrectItemDetails: document.getElementById('incorrect-item-details'),
            feedbackImageContainer: document.getElementById('feedback-image-container'),
            feedbackImagePreview: document.getElementById('feedback-image-preview'),
            feedbackImageDelete: document.getElementById('feedback-image-delete'),
            cancelFeedbackBtn: document.getElementById('cancel-feedback-btn'),
            submitFeedbackBtn: document.getElementById('submit-feedback-btn'),
            feedbackTextareaContainer: document.getElementById('feedback-textarea-container'),
            
            historySearchInput: document.getElementById('history-search-input'),
            historySearchBtn: document.getElementById('history-search-btn'),
            historyResults: document.getElementById('history-results'),
            
            historyModal: document.getElementById('history-report-modal'),
            historyModalTitle: document.getElementById('history-modal-title'),
            historyModalSubtitle: document.getElementById('history-modal-subtitle'),
            historyReportContent: document.getElementById('history-report-content'),
            closeHistoryBtn: document.getElementById('close-history-btn'),
            closeHistoryFooterBtn: document.getElementById('close-history-footer-btn'),
        };

        // --- HELPER FUNCTIONS ---
        function updateChartsTheme() {
            if(document.getElementById('tab-analytics') && !document.getElementById('tab-analytics').classList.contains('hidden')) {
                loadAnalytics(); 
            }
        }

        async function loadAnalytics() {
            if(!db) return;
            const snap = await getDocs(query(collection(db, 'orderbot_comparisons'), orderBy('timestamp', 'desc'))); 
            const data = snap.docs.map(d => d.data());
            fetchedHistoryData = data;
            
            const matches = data.filter(d => !d.motorValidation && !(d.lineItems || []).some(i => Object.values(i).some(v => v && v.result === 'MISMATCH'))).length;
            const fails = data.length - matches;
            
            if(window.trendChartInst) window.trendChartInst.destroy();
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#fff' : '#000';
            const gridColor = isDark ? '#334155' : '#e2e8f0';

            window.trendChartInst = new Chart(el.trendChartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Clean Orders', 'Orders with Issues'],
                    datasets: [{ data: [matches, fails], backgroundColor: ['#22c55e', '#ef4444'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } } } }
            });
            
            const fieldErrors = { Width: 0, Drop: 0, Colour: 0, Control: 0 };
            data.forEach(d => {
                (d.lineItems || []).forEach(item => {
                    if(item.width?.result === 'MISMATCH') fieldErrors.Width++;
                    if(item.drop?.result === 'MISMATCH') fieldErrors.Drop++;
                    if(item.colour?.result === 'MISMATCH') fieldErrors.Colour++;
                    if(item.control?.result === 'MISMATCH') fieldErrors.Control++;
                });
            });
            
            if(window.distChartInst) window.distChartInst.destroy();
            window.distChartInst = new Chart(el.distributionChartCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(fieldErrors),
                    datasets: [{ label: 'Mismatches', data: Object.values(fieldErrors), backgroundColor: '#6366f1' }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } }, x: { grid: { display: false }, ticks: { color: textColor } } }, plugins: { legend: { display: false } } }
            });
            
            renderHistoryList(data.slice(0, 10));
        }

        function renderHistoryList(list) {
             el.historyResults.innerHTML = list.map((d, index) => 
                `<div class="history-item flex justify-between p-3 bg-slate-50 dark:bg-slate-900 rounded border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors group" data-index="${index}">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-slate-400 group-hover:text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <span class="font-mono text-sm text-slate-700 dark:text-slate-300 font-bold">${d.bdoOrderNumber || 'N/A'}</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-xs text-slate-500">${new Date(d.timestamp).toLocaleDateString()}</span>
                        <svg class="w-4 h-4 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </div>
                </div>`
            ).join('');
            
            el.historyResults.querySelectorAll('.history-item').forEach(item => {
                item.addEventListener('click', () => {
                    const dataIndex = item.dataset.index;
                    const reportData = list[dataIndex];
                    openHistoryModal(reportData);
                });
            });
        }
        
        // --- THEME LOGIC ---
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
        el.themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            updateChartsTheme(); 
        });

        // --- TABS LOGIC ---
        el.tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                el.tabBtns.forEach(b => b.classList.remove('active'));
                el.tabContents.forEach(c => c.classList.add('hidden'));
                btn.classList.add('active');
                document.getElementById(`tab-${btn.dataset.tab}`).classList.remove('hidden');
                if(btn.dataset.tab === 'analytics') loadAnalytics();
            });
        });

        // --- UPLOAD & SORTABLE LOGIC ---
        const sortable = new Sortable(el.uploadPairsContainer, {
            animation: 150,
            handle: '.handle',
            onEnd: (evt) => {
                const item = comparisonPairs.splice(evt.oldIndex, 1)[0];
                comparisonPairs.splice(evt.newIndex, 0, item);
                updatePairLabels();
            }
        });

        function updatePairLabels() {
            document.querySelectorAll('.pair-label').forEach((label, idx) => label.textContent = `Order Pair ${idx + 1}`);
        }

        function addNewPair() {
            const newPair = { customerFiles: [], blindIQFiles: [] };
            comparisonPairs.push(newPair);
            const index = comparisonPairs.length - 1;
            const template = document.getElementById('upload-pair-template').content.cloneNode(true);
            const pairEl = template.querySelector('.upload-pair');
            pairEl.dataset.index = index;
            
            const dz1 = pairEl.querySelectorAll('.drop-zone')[0];
            const dz2 = pairEl.querySelectorAll('.drop-zone')[1];
            setupDropZone(dz1, newPair.customerFiles);
            setupDropZone(dz2, newPair.blindIQFiles);
            
            el.uploadPairsContainer.appendChild(pairEl);
            updatePairLabels();
            checkCompareState();
        }

        function setupDropZone(zone, fileArray) {
            const input = zone.querySelector('input');
            const list = zone.querySelector('.file-list');
            const emptyState = zone.querySelector('.empty-state');

            zone.addEventListener('click', (e) => { if(e.target === zone || e.target.closest('.empty-state')) input.click(); });
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', (e) => { 
                e.preventDefault(); zone.classList.remove('drag-over'); 
                handleFiles(e.dataTransfer.files, fileArray, list, emptyState); 
            });
            input.addEventListener('change', (e) => handleFiles(e.target.files, fileArray, list, emptyState));
        }

        function handleFiles(files, array, listEl, emptyState) {
            Array.from(files).forEach(file => {
                if(['application/pdf', 'image/jpeg', 'image/png'].includes(file.type) || 
                   file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    array.push(file);
                }
            });
            renderFilePreviews(array, listEl);
            if (array.length > 0) emptyState.classList.add('hidden');
            checkCompareState();
        }

        function renderFilePreviews(files, container) {
            container.innerHTML = '';
            files.forEach((file, idx) => {
                const div = document.createElement('div');
                div.className = 'file-preview-item flex items-center justify-center bg-white dark:bg-slate-700 shadow-sm relative group';
                
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.className = 'w-full h-full object-cover';
                    div.appendChild(img);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    div.innerHTML = '<span class="text-[10px] font-bold text-green-600">XLS</span>';
                } else {
                    div.innerHTML = '<span class="text-[10px] font-bold text-red-500">PDF</span>';
                }
                
                const removeBtn = document.createElement('div');
                removeBtn.className = 'absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white cursor-pointer';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = (e) => { e.stopPropagation(); files.splice(idx, 1); renderFilePreviews(files, container); checkCompareState(); };
                div.appendChild(removeBtn);
                container.appendChild(div);
            });
        }

        function checkCompareState() {
            el.compareBtn.disabled = !comparisonPairs.some(p => p.customerFiles.length && p.blindIQFiles.length);
        }

        el.addPairBtn.addEventListener('click', addNewPair);
        el.newComparisonBtn.addEventListener('click', () => {
            el.reportSection.classList.add('hidden');
            comparisonPairs = [];
            el.uploadPairsContainer.innerHTML = '';
            addNewPair();
            el.reportSection.scrollIntoView({ behavior: 'smooth' }); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // --- COMPARISON LOGIC ---
        el.compareBtn.addEventListener('click', async () => {
            el.compareBtn.disabled = true;
            el.compareBtn.textContent = 'Processing...';
            
            const [fabrics, motors, tubes] = await Promise.all([getFabricProperties(), getMotorProperties(), getTubeProperties()]);
            
            summaryResultsCache = [];
            for (let i=0; i<comparisonPairs.length; i++) {
                const pair = comparisonPairs[i];
                if(!pair.customerFiles.length || !pair.blindIQFiles.length) continue;
                try {
                     const result = await processComparison(pair);
                     const validated = runPostAIValidations(result, fabrics, motors, tubes);
                     summaryResultsCache.push({ status: 'success', data: validated });
                } catch (e) {
                    console.error(e);
                    summaryResultsCache.push({ status: 'error', msg: e.message });
                }
            }
            
            renderReport();
            el.reportSection.classList.remove('hidden');
            el.compareBtn.textContent = 'Run Intelligent Comparison';
            el.compareBtn.disabled = false;
            el.reportSection.scrollIntoView({ behavior: 'smooth' });
        });

        const readExcel = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const csv = XLSX.utils.sheet_to_csv(firstSheet);
                resolve(csv);
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });

        async function processComparison(pair) {
            let systemPromptAppend = "";
            if (db) {
                const rulesSnap = await getDocs(query(collection(db, 'orderbot_structured_rules')));
                const guideSnap = await getDocs(query(collection(db, 'orderbot_guidelines')));
                const fbSnap = await getDocs(query(collection(db, 'orderbot_feedback'), orderBy('timestamp', 'desc'))); 
                
                const rules = rulesSnap.docs.map(d => d.data());
                const guides = guideSnap.docs.map(d => d.data().enhancedGuideline);
                const fbs = fbSnap.docs.slice(0,5).map(d => d.data()); 

                if(rules.length) {
                    const formattedRules = rules.map(r => {
                        let ruleSentence = `IF `;
                        if(r.conditions) {
                            r.conditions.forEach((c, index) => {
                                if (index > 0) ruleSentence += ` ${c.logic.toUpperCase()} `;
                                ruleSentence += `${c.field} ${c.operator.replace(/_/g, ' ')} "${c.value}"`;
                            });
                        } else {
                             ruleSentence += `${r.field} ${r.condition} "${r.value}"`;
                        }
                        ruleSentence += ` THEN: ${r.requirement}`;
                        return ruleSentence;
                    });
                    systemPromptAppend += `\n## CRITICAL LOGIC RULES:\n${formattedRules.map(s => `- ${s}`).join('\n')}`;
                }
                
                if(guides.length) systemPromptAppend += `\n## GENERAL GUIDELINES:\n${guides.map(g => `- ${g}`).join('\n')}`;
                if(fbs.length) systemPromptAppend += `\n## LEARNING EXAMPLES:\n${fbs.map(f => `- Correction: ${f.enhancedExplanation}`).join('\n')}`;
            }

            const comparisonFieldSchema = { type: "OBJECT", properties: { "customerValue": { "type": "STRING" }, "blindIQValue": { "type": "STRING" }, "result": { "type": "STRING", "enum": ["MATCH", "MISMATCH", "OMISSION", "NOTE"] }, "confidence": { "type": "NUMBER" } }, required: ["customerValue", "blindIQValue", "result", "confidence"] };
            const schema = {
                type: "OBJECT",
                properties: {
                    "bdoOrderNumber": { "type": "STRING" },
                    "customerOrderNumber": comparisonFieldSchema,
                    "specialInstructions": comparisonFieldSchema,
                    "lineItems": {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "item": comparisonFieldSchema,
                                "location": comparisonFieldSchema,
                                "qty": comparisonFieldSchema,
                                "width": comparisonFieldSchema,
                                "drop": comparisonFieldSchema,
                                "colour": comparisonFieldSchema,
                                "control": comparisonFieldSchema,
                                "blindType": comparisonFieldSchema,
                                "range": comparisonFieldSchema,
                                "fix": comparisonFieldSchema,
                                "specifications": {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "specName": { "type": "STRING" },
                                            "specComparison": comparisonFieldSchema
                                        },
                                        required: ["specName", "specComparison"]
                                    }
                                }
                            },
                            required: ["item", "location", "qty", "width", "drop", "colour", "control", "blindType", "range", "fix"]
                        }
                    },
                    "sundries": {
                        type: "ARRAY",
                        items: {
                           type: "OBJECT",
                            properties: {
                                "item": comparisonFieldSchema,
                                "quantity": { "type": "NUMBER" }
                            },
                            required: ["item", "quantity"]
                        }
                    }
                },
                required: ["bdoOrderNumber", "customerOrderNumber", "lineItems"]
            };

            const prompt = `You are OrderBot, an AI assistant.
            Analyze 'customer' vs 'blindiq' files.
            For each line item in the 'Blinds' table, extract: Item, Location, QTY, Width, Drop, Colour, Control, Blind Type, Range, and Fix.
            'Range' is the fabric name.
            Extract 'specifications' (key=value pairs) from secondary text lines.
            Compare 'Sundries'.
            ${systemPromptAppend}`;

            const parts = [{ text: prompt }];
             const toB64 = f => new Promise((r,j) => { const fr=new FileReader(); fr.onload=()=>r(fr.result.split(',')[1]); fr.onerror=j; fr.readAsDataURL(f); });
             
             // Customer Files
             for(const f of pair.customerFiles) {
                 if (f.name.endsWith('.xlsx') || f.name.endsWith('.xls')) {
                     const csv = await readExcel(f);
                     parts.push({ text: `--- START CUSTOMER EXCEL FILE: ${f.name} ---\n${csv}\n--- END CUSTOMER EXCEL FILE ---` });
                 } else {
                     parts.push({ text: `CUST FILE: ${f.name}` }, { inlineData: { mimeType: f.type, data: await toB64(f) }});
                 }
             }
             
             // BlindIQ Files
             for(const f of pair.blindIQFiles) {
                 if (f.name.endsWith('.xlsx') || f.name.endsWith('.xls')) {
                     const csv = await readExcel(f);
                     parts.push({ text: `--- START BLIND IQ EXCEL FILE: ${f.name} ---\n${csv}\n--- END BLIND IQ EXCEL FILE ---` });
                 } else {
                     parts.push({ text: `BLIND IQ FILE: ${f.name}` }, { inlineData: { mimeType: f.type, data: await toB64(f) }});
                 }
             }

             // HARDCODED MODEL: gemini-3-pro-preview
             const resp = await fetch(PROXY_API_URL, {
                 method: 'POST',
                 headers: {'Content-Type': 'application/json'},
                 body: JSON.stringify({
                     model: 'gemini-3-pro-preview',
                     payload: {
                         contents: [{ role: "user", parts }],
                         generationConfig: { responseMimeType: "application/json", responseSchema: schema } 
                     }
                 })
             });
             
             if (!resp.ok) throw new Error("API Failed");
             const json = await resp.json();
             return JSON.parse(json.candidates[0].content.parts[0].text);
        }
        
        // --- REPORT RENDERER ---
        
        function generateReportBodyHtml(d) {
            let validationsHtml = '';
            if (d.motorValidation?.global) validationsHtml += `<div class="p-3 bg-red-100 text-red-800 text-sm font-bold border-b border-red-200 rounded-t-lg mb-4">${d.motorValidation.global}</div>`;
            
            let html = `${validationsHtml}<div class="overflow-x-auto"><table class="w-full text-sm text-left">
                <thead class="bg-slate-50 dark:bg-slate-900 text-xs uppercase text-slate-500"><tr><th class="p-3">Item</th><th class="p-3">Type</th><th class="p-3">Size</th><th class="p-3">Colour</th><th class="p-3">Control</th><th class="p-3">Confidence</th></tr></thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-700">`;
            
            (d.lineItems || []).forEach((item, rIdx) => {
                const isMis = Object.values(item).some(v => v && v.result === 'MISMATCH');
                const avgConf = Math.round((Object.values(item).reduce((acc, v) => acc + (v?.confidence || 0), 0) / 10) * 100);
                const confColor = avgConf > 90 ? 'bg-green-500' : avgConf > 70 ? 'bg-yellow-500' : 'bg-red-500';
                
                let lineAlerts = '';
                if(item.fabricValidation) lineAlerts += `<div class="text-xs text-red-600 font-bold block mt-1">â  ${item.fabricValidation.message}</div>`;
                if(item.colourValidation) lineAlerts += `<div class="text-xs text-red-600 font-bold block mt-1">â  ${item.colourValidation.message}</div>`;
                if(item.controlValidation) lineAlerts += `<div class="text-xs text-red-600 font-bold block mt-1">â  ${item.controlValidation.message}</div>`;
                if(item.torqueValidation) lineAlerts += `<div class="text-xs text-red-600 font-bold block mt-1">â  ${item.torqueValidation.message}</div>`;
                if(item.motorValidation) item.motorValidation.forEach(m => lineAlerts += `<div class="text-xs text-red-600 font-bold block mt-1">â  ${m}</div>`);

                const renderContent = (field) => {
                    let content = field.blindIQValue || '-';
                    if (field.result === 'MISMATCH') {
                        content += ` <span class="text-xs text-red-500 font-bold block">(vs ${field.customerValue || '-'})</span>`;
                    }
                    return content;
                };

                html += `
                    <tr class="line-item-container ${isMis ? 'bg-red-50/50 dark:bg-red-900/10' : ''} hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors" data-row-index="${rIdx}">
                        <td class="p-3 font-medium reportable-cell" data-field-name="item">${renderContent(item.item)}</td>
                        <td class="p-3 reportable-cell" data-field-name="blindType">
                            ${renderContent(item.blindType)}
                            ${lineAlerts}
                        </td>
                        <td class="p-3">
                            <span class="reportable-cell" data-field-name="width">${renderContent(item.width)}</span> x <span class="reportable-cell" data-field-name="drop">${renderContent(item.drop)}</span>
                        </td>
                        <td class="p-3 reportable-cell" data-field-name="colour">${renderContent(item.colour)}</td>
                        <td class="p-3 reportable-cell" data-field-name="control">${renderContent(item.control)}</td>
                        <td class="p-3 w-32">
                            <div class="flex items-center gap-2">
                                <div class="flex-grow bg-slate-200 dark:bg-slate-600 rounded-full h-1.5">
                                    <div class="${confColor} h-1.5 rounded-full" style="width: ${avgConf}%"></div>
                                </div>
                                <span class="text-xs text-slate-500">${avgConf}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });
            html += `</tbody></table></div>`;
            
            if(d.sundries?.length) {
                    html += `<div class="p-3 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/30"><h5 class="text-xs font-bold uppercase text-slate-500 mb-2">Sundries</h5>`;
                    d.sundries.forEach(s => {
                        let logs = '';
                        if(s.validationLog) {
                            logs = `<ul class="text-xs mt-1 space-y-1 pl-4 border-l-2 border-slate-300">${s.validationLog.map(l => `<li class="${l.status==='PASS'?'text-green-600':'text-red-600'}">${l.status==='PASS'?'â':'â'} ${l.check}</li>`).join('')}</ul>`
                        }
                        html += `<div class="text-sm py-1 border-b border-slate-200/50 last:border-0">
                        <div class="flex justify-between"><span>${s.quantity}x ${s.item.blindIQValue}</span><span class="${s.item.result === 'MATCH' ? 'text-green-600' : 'text-red-600'}">${s.item.result}</span></div>
                        ${logs}
                        </div>`
                    });
                    html += `</div>`;
            }
            return html;
        }

        function attachReportCellListeners(container, data) {
            container.querySelectorAll('.reportable-cell').forEach(cell => {
                cell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if(!db) return;
                    const rowIdx = cell.closest('tr').dataset.rowIndex;
                    const field = cell.dataset.fieldName;
                    const lineItem = data.lineItems[rowIdx];
                    itemToCorrect = {
                        lineItemIdentifier: { item: lineItem.item.blindIQValue, location: lineItem.location.blindIQValue },
                        fieldName: field,
                        fieldData: lineItem[field]
                    };
                    el.incorrectItemDetails.textContent = JSON.stringify(lineItem[field], null, 2);
                    el.feedbackModal.classList.remove('hidden');
                });
            });
        }

        function renderReport() {
            const container = el.reportContent;
            container.innerHTML = '';
            
            summaryResultsCache.forEach((res, idx) => {
                if(res.status === 'error') {
                    container.innerHTML += `<div class="p-4 bg-red-100 text-red-800 rounded-lg mb-4">Error: ${res.msg}</div>`;
                    return;
                }
                const d = res.data;
                
                let hasErrors = d.motorValidation;
                (d.lineItems || []).forEach(i => {
                     if (i.fabricValidation || i.colourValidation || i.motorValidation || i.torqueValidation || i.controlValidation) hasErrors = true;
                     if (Object.values(i).some(v => v && v.result === 'MISMATCH')) hasErrors = true;
                     if (i.specifications?.some(s => s.specComparison.result === 'MISMATCH')) hasErrors = true;
                });

                const card = document.createElement('div');
                card.className = `border rounded-xl overflow-hidden mb-6 transition-all ${hasErrors ? 'border-red-200 dark:border-red-900' : 'border-slate-200 dark:border-slate-700'}`;
                
                const header = document.createElement('div');
                header.className = `p-4 cursor-pointer flex justify-between items-center ${hasErrors ? 'bg-red-50 dark:bg-red-900/20' : 'bg-white dark:bg-slate-800'}`;
                header.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-mono font-bold text-lg text-slate-700 dark:text-slate-200">${d.bdoOrderNumber || 'Unknown Order'}</span>
                        ${hasErrors ? '<span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-bold rounded">ATTENTION</span>' : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded">MATCH</span>'}
                    </div>
                    <button class="text-indigo-600 text-sm font-medium hover:underline view-diff-btn">View Visual Diff</button>
                `;
                
                header.querySelector('.view-diff-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openDiffModal(d);
                });

                const body = document.createElement('div');
                body.className = 'p-0 bg-white dark:bg-slate-800 hidden'; 
                
                body.innerHTML = generateReportBodyHtml(d);
                
                header.addEventListener('click', () => body.classList.toggle('hidden'));
                card.appendChild(header);
                card.appendChild(body);
                container.appendChild(card);
                
                attachReportCellListeners(body, d);

                if(db && d.bdoOrderNumber) addDoc(collection(db, 'orderbot_comparisons'), { ...d, timestamp: new Date().toISOString(), userId });
            });
        }
        
        function openHistoryModal(data) {
            el.historyModalTitle.textContent = `Report: ${data.bdoOrderNumber || 'Unknown Order'}`;
            el.historyModalSubtitle.textContent = `Generated on ${new Date(data.timestamp).toLocaleString()}`;
            el.historyReportContent.innerHTML = generateReportBodyHtml(data);
            attachReportCellListeners(el.historyReportContent, data);
            el.historyModal.classList.remove('hidden');
        }
        
        const closeHistory = () => el.historyModal.classList.add('hidden');
        el.closeHistoryBtn.addEventListener('click', closeHistory);
        el.closeHistoryFooterBtn.addEventListener('click', closeHistory);

        // --- RULE BUILDER LOGIC (OVERHAULED) ---

        function addConditionRow(isFirst = false) {
            const row = document.createElement('div');
            row.className = 'grid grid-cols-12 gap-2 items-center condition-row';
            
            let logicHtml = '';
            if (!isFirst) {
                logicHtml = `
                    <div class="col-span-2">
                        <select class="w-full p-2 bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded text-xs font-bold condition-logic">
                            <option value="and">AND</option>
                            <option value="or">OR</option>
                        </select>
                    </div>
                `;
            } else {
                logicHtml = `<div class="col-span-2"><span class="text-xs font-bold text-slate-400 pl-2">IF</span></div>`;
            }

            row.innerHTML = `
                ${logicHtml}
                <div class="col-span-4">
                    <select class="w-full p-2 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded text-sm condition-field">
                        <option value="Blind Type">Blind Type</option>
                        <option value="Width">Width</option>
                        <option value="Drop">Drop</option>
                        <option value="Control">Control</option>
                        <option value="Colour">Colour</option>
                        <option value="Range">Range (Fabric)</option>
                        <option value="Fix">Fix</option>
                        <option value="Item Letter">Item Letter</option>
                    </select>
                </div>
                <div class="col-span-3">
                    <select class="w-full p-2 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded text-sm condition-operator">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="does_not_contain">Does Not Contain</option>
                        <option value="starts_with">Starts With</option>
                        <option value="ends_with">Ends With</option>
                        <option value="greater_than">Greater Than</option>
                        <option value="less_than">Less Than</option>
                    </select>
                </div>
                <div class="${isFirst ? 'col-span-3' : 'col-span-2'}">
                    <input type="text" class="w-full p-2 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded text-sm condition-value" placeholder="Value">
                </div>
                ${!isFirst ? `<div class="col-span-1 text-center"><button class="text-red-500 hover:text-red-700 font-bold remove-condition-btn">&times;</button></div>` : ''}
            `;
            
            if (!isFirst) {
                row.querySelector('.remove-condition-btn').addEventListener('click', () => row.remove());
            }

            el.ruleConditionsContainer.appendChild(row);
        }

        addConditionRow(true);

        el.addConditionBtn.addEventListener('click', () => addConditionRow(false));

        el.saveComplexRuleBtn.addEventListener('click', async () => {
            const rows = el.ruleConditionsContainer.querySelectorAll('.condition-row');
            const conditions = [];
            let isValid = true;

            rows.forEach((row, index) => {
                const field = row.querySelector('.condition-field').value;
                const operator = row.querySelector('.condition-operator').value;
                const value = row.querySelector('.condition-value').value;
                let logic = 'and'; 
                
                if (index > 0) {
                    logic = row.querySelector('.condition-logic').value;
                }

                if (!value) isValid = false;

                conditions.push({ field, operator, value, logic });
            });

            const requirement = el.ruleRequirement.value;

            if (!isValid || !requirement) {
                alert("Please fill in all fields and requirements.");
                return;
            }

            const ruleObject = {
                conditions,
                requirement,
                userId,
                timestamp: new Date().toISOString(),
                type: 'complex'
            };

            await addDoc(collection(db, 'orderbot_structured_rules'), ruleObject);
            
            el.ruleConditionsContainer.innerHTML = '';
            addConditionRow(true);
            el.ruleRequirement.value = '';
            loadRules();
        });

        el.addLegacyGuidelineBtn.addEventListener('click', async () => {
            const text = el.legacyGuidelineInput.value.trim();
            if(!text) return;
            
            el.addLegacyGuidelineBtn.disabled = true;
            el.addLegacyGuidelineBtn.textContent = "...";
            
            // HARDCODED MODEL: gemini-2.5-flash
            const enhanced = await enhanceText(text, 'gemini-2.5-flash'); 
            await addDoc(collection(db, 'orderbot_guidelines'), { userId, timestamp: new Date().toISOString(), enhancedGuideline: enhanced });
            
            el.addLegacyGuidelineBtn.disabled = false;
            el.addLegacyGuidelineBtn.textContent = "Add";
            el.legacyGuidelineInput.value = '';
            loadRules();
        });

        async function loadRules() {
            if(!db) return;
            const rulesSnap = await getDocs(query(collection(db, 'orderbot_structured_rules')));
            const guidesSnap = await getDocs(query(collection(db, 'orderbot_guidelines')));
            
            el.rulesContainer.innerHTML = '';
            el.rulesContainer.innerHTML += rulesSnap.docs.map(d => {
                const r = d.data();
                let ruleString = `IF `;
                if (r.conditions) {
                    r.conditions.forEach((c, idx) => {
                        if (idx > 0) ruleString += ` <strong class="text-indigo-600 dark:text-indigo-400">${c.logic.toUpperCase()}</strong> `;
                        ruleString += `${c.field} <em>${c.operator.replace(/_/g, ' ')}</em> "${c.value}"`;
                    });
                } else {
                     ruleString += `${r.field} ${r.condition} "${r.value}"`;
                }
                ruleString += ` THEN <strong>${r.requirement}</strong>`;

                return `<div class="p-3 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-lg text-sm flex justify-between items-center">
                    <span>${ruleString}</span>
                    <button class="text-red-400 hover:text-red-600 font-bold ml-2" onclick="window.deleteRule('${d.id}', 'structured')">&times;</button>
                </div>`;
            }).join('');
            
            document.getElementById('guidelines-list').innerHTML = guidesSnap.docs.map(d => 
                `<div class="p-2 bg-slate-50 dark:bg-slate-700 rounded flex justify-between items-center"><span>${d.data().enhancedGuideline}</span><button class="text-red-400 font-bold" onclick="window.deleteRule('${d.id}', 'legacy')">&times;</button></div>`
            ).join('');
        }
        
        window.deleteRule = async (id, type) => {
            el.confirmModal.classList.remove('hidden');
            const onConfirm = async () => {
                await deleteDoc(doc(db, type === 'structured' ? 'orderbot_structured_rules' : 'orderbot_guidelines', id));
                loadRules();
                cleanup();
            };
            const cleanup = () => {
                 el.confirmModal.classList.add('hidden');
                 el.confirmModalConfirm.removeEventListener('click', onConfirm);
            };
            el.confirmModalConfirm.addEventListener('click', onConfirm);
        };
        
        el.historySearchBtn.onclick = () => {
             if(!fetchedHistoryData) return;
             const term = el.historySearchInput.value.toLowerCase();
             const filtered = fetchedHistoryData.filter(d => JSON.stringify(d).toLowerCase().includes(term));
             renderHistoryList(filtered);
        };

        el.exportPdfBtn.addEventListener('click', () => {
            const element = document.getElementById('report-content');
            html2pdf().set({ margin: 0.5, filename: 'comparison_report.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } }).from(element).save();
        });
        
        function openDiffModal(data) {
             let html = `<h4 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Data Comparison</h4>`;
             (data.lineItems || []).forEach((item, idx) => {
                 html += `<div class="mb-6 p-4 bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600">
                    <h5 class="font-bold text-sm mb-2">Line Item ${idx + 1} (${item.item.blindIQValue})</h5>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                         <div><span class="text-xs text-slate-500 uppercase">Customer Value</span></div>
                         <div><span class="text-xs text-slate-500 uppercase">Extracted Value</span></div>
                         
                         ${['width','drop','colour','control'].map(k => {
                             const res = item[k]?.result;
                             const cls = res === 'MISMATCH' ? 'diff-highlight-red' : 'diff-highlight-green';
                             return `
                                <div class="font-mono text-slate-600 dark:text-slate-300 border-b border-slate-200 dark:border-slate-600 pb-1">${k}: ${item[k]?.customerValue || '-'}</div>
                                <div class="font-mono font-bold ${cls} border-b border-slate-200 dark:border-slate-600 pb-1">${item[k]?.blindIQValue || '-'}</div>
                             `;
                         }).join('')}
                    </div>
                 </div>`;
             });
             el.diffContent.innerHTML = html;
             el.diffModal.classList.remove('hidden');
        }
        el.closeDiffBtn.addEventListener('click', () => el.diffModal.classList.add('hidden'));
        
        [el.fabricHeader, el.motorHeader, el.tubeHeader].forEach((h, i) => {
            const c = [el.fabricContent, el.motorContent, el.tubeContent][i];
            h.addEventListener('click', () => {
                c.classList.toggle('hidden');
                h.querySelector('.chevron-icon').classList.toggle('rotate-180');
            });
        });
        
        el.cancelFeedbackBtn.onclick = () => el.feedbackModal.classList.add('hidden');
        el.submitFeedbackBtn.onclick = async () => {
            const text = el.feedbackTextarea.value;
            if(!text) return;
            el.submitFeedbackBtn.disabled = true;
            
            // HARDCODED MODEL: gemini-2.5-flash
            const enhanced = await enhanceText(text, 'gemini-2.5-flash');
            await addDoc(collection(db, 'orderbot_feedback'), {
                userId, timestamp: new Date().toISOString(),
                incorrectItem: itemToCorrect,
                userExplanation: text,
                enhancedExplanation: enhanced
            });
            el.feedbackModal.classList.add('hidden');
            el.submitFeedbackBtn.disabled = false;
            el.feedbackTextarea.value = '';
        };

        function runPostAIValidations(comparisonData, fabricProperties, motorProperties, tubeProperties) {
            if (!comparisonData) return comparisonData;
        
            if (comparisonData.lineItems) {
                comparisonData.lineItems.forEach(item => {
                    // 1. Fabric Width & Drop
                    if (fabricProperties && fabricProperties.size > 0) {
                        const fabricName = item.range?.blindIQValue?.toLowerCase().trim();
                        const widthString = item.width?.blindIQValue || '';
                        const widthMatch = widthString.match(/\d+/);
                        const blindWidth = widthMatch ? parseInt(widthMatch[0], 10) : NaN;
                        const dropString = item.drop?.blindIQValue || '';
                        const dropMatch = dropString.match(/\d+/);
                        const blindDrop = dropMatch ? parseInt(dropMatch[0], 10) : NaN;

                        if (fabricName && !isNaN(blindWidth) && !isNaN(blindDrop)) {
                            const properties = fabricProperties.get(fabricName);
                            if (properties) {
                                const fabricWidth = properties.fabricWidth;
                                const canTurn = properties.canTurn.toLowerCase();
                                if (blindWidth > fabricWidth) {
                                    if (canTurn === 'no') {
                                        item.fabricValidation = { type: 'error', message: `Fabric Alert: Width (${blindWidth}mm) exceeds max fabric width (${fabricWidth}mm). Fabric cannot be turned.` };
                                    } else if (canTurn === 'yes' || canTurn === 'out') {
                                        if (blindDrop > fabricWidth) {
                                            item.fabricValidation = { type: 'error', message: `Fabric Alert: Drop (${blindDrop}mm) exceeds max turned width (${fabricWidth}mm). Blind cannot be made.` };
                                        } else if (canTurn === 'out') {
                                            item.fabricValidation = { type: 'warning', message: `Fabric Alert: Width (${blindWidth}mm) exceeds fabric width (${fabricWidth}mm). Turning is Out of Warranty.` };
                                        }
                                    }
                                }
                            }
                        }
                    }
                    // 2. Colour
                    const blindType = item.blindType?.blindIQValue?.toLowerCase().trim();
                    const colour = item.colour?.blindIQValue?.trim();
                    if (blindType && !BLIND_TYPE_EXCLUSIONS_FOR_COLOUR_CHECK.includes(blindType)) {
                        if (!colour || colour === 'N/A' || colour === '-') {
                            item.colourValidation = { type: 'error', message: `Colour Alert: No colour has been specified.` };
                        }
                    }
                    // 3. Control
                    const controlValue = item.control?.blindIQValue?.toLowerCase() || '';
                    if (blindType && BLIND_TYPES_REQUIRING_CONTROL_VALIDATION.includes(blindType)) {
                        const hasValidControl = controlValue.includes('chain') || controlValue.includes('motor') || controlValue.includes('dual');
                        if (!hasValidControl) {
                            item.controlValidation = { type: 'error', message: `Control Alert: Invalid configuration.` };
                        }
                    }
                });
            }
            // 4. Motor
            if (motorProperties && motorProperties.length > 0 && comparisonData.sundries && tubeProperties) {
                 validateMotorDependencies(comparisonData, motorProperties, tubeProperties, fabricProperties);
            }
            return comparisonData;
        }
        
        function validateMotorDependencies(data, motorProperties, tubeProperties, fabricProperties) {
            const motorizedBlinds = (data.lineItems || []).filter(item => {
                const control = item.control?.blindIQValue?.toLowerCase() || '';
                return control.includes('motor') || control.includes('dual');
            });

            if (motorizedBlinds.length === 0) return;

            const sundries = data.sundries || [];
            let orderedMotors = [];
            const orderedAdapters = new Set();
            const orderedControllers = new Set();
            const orderedAccessories = new Set();
            const orderedDependencies = new Set();

            sundries.forEach(sundry => {
                const desc = sundry.item.blindIQValue.toLowerCase();
                let isMotor = false;
                const matchingProps = motorProperties.filter(prop => desc.includes(prop.motorName.toLowerCase()));
                if (matchingProps.length > 0 && desc.includes('motor')) {
                     for(let i=0; i < sundry.quantity; i++) orderedMotors.push({ sundry: sundry, potentialProps: matchingProps, assignedBlind: null });
                    isMotor = true;
                }
                if (!isMotor) {
                    if (desc.includes('adapter')) orderedAdapters.add(sundry.item.blindIQValue);
                    else if (desc.includes('remote') || desc.includes('switch') || desc.includes('hub')) orderedControllers.add(sundry.item.blindIQValue);
                    else if (desc.includes('accessory')) orderedAccessories.add(sundry.item.blindIQValue);
                    else orderedDependencies.add(sundry.item.blindIQValue);
                }
            });

            if (motorizedBlinds.length !== orderedMotors.length) {
                data.motorValidation = { global: `Motor Alert: Order has ${motorizedBlinds.length} motorized blinds but ${orderedMotors.length} motors were found in sundries.` };
                return;
            }
            
             motorizedBlinds.forEach(blind => blind.calculatedArea = (parseInt(blind.width?.blindIQValue) / 1000) * (parseInt(blind.drop?.blindIQValue) / 1000));
            motorizedBlinds.sort((a, b) => b.calculatedArea - a.calculatedArea);
            orderedMotors.sort((a, b) => Math.max(...b.potentialProps.map(p => p.torque)) - Math.max(...a.potentialProps.map(p => p.torque)));

            motorizedBlinds.forEach((blind, i) => { if (orderedMotors[i]) orderedMotors[i].assignedBlind = blind; });

            orderedMotors.forEach(motorObj => {
                const blind = motorObj.assignedBlind;
                if (!blind) return;
                const blindType = blind.blindType.blindIQValue;
                const motorProp = motorObj.potentialProps.find(p => p.blindType.toLowerCase().trim() === blindType.toLowerCase().trim());

                if (!blind.motorValidation) blind.motorValidation = [];
                if (!motorProp) {
                    blind.motorValidation.push(`Motor Alert: Incompatible motor for blind type "${blindType}".`);
                    return;
                }

                const fabric = fabricProperties.get(blind.range.blindIQValue.toLowerCase().trim());
                const tube = tubeProperties.get(blind.blindType.blindIQValue.toLowerCase().trim());
                if (fabric && tube) {
                     const weight = (parseInt(blind.width.blindIQValue)/1000 * parseInt(blind.drop.blindIQValue)/1000 * fabric.fabricWeight) + (parseInt(blind.width.blindIQValue)/1000 * 0.280);
                     const radius = (tube.tubeDiameter / 1000) / 2;
                     const reqTorque = (weight * 9.81 * radius).toFixed(2);
                     blind.requiredTorque = reqTorque;
                     if (motorProp.torque < reqTorque) blind.torqueValidation = { message: `Torque Alert: Insufficient torque.` };
                }
                const check = (set, req) => {
                    const r = (req||'').toLowerCase().split(',').map(s=>s.trim()).filter(s=>s);
                    if(!r.length) return true;
                    return [...set].some(i => r.some(x => i.toLowerCase().includes(x)));
                }
                if(!check(orderedAdapters, motorProp.adapterKit)) blind.motorValidation.push(`Missing adapter: ${motorProp.adapterKit}`);
                if(!check(orderedControllers, motorProp.controlOptions)) blind.motorValidation.push(`Missing controller`);
                
                 if(!motorObj.sundry.validationLog) motorObj.sundry.validationLog = [];
                 motorObj.sundry.validationLog.push({ check: `Matched to Blind ${blind.item.blindIQValue}`, status: 'PASS', details: 'Torque & Compat OK' });
            });
        }

        el.fabricCsvUpload.addEventListener('change', e => processCsv(e.target.files[0], 'fabric'));
        el.addFabricBtn.addEventListener('click', () => renderPropRow('fabric', null, {}, true));
        
        el.motorCsvUpload.addEventListener('change', e => processCsv(e.target.files[0], 'motor'));
        el.addMotorBtn.addEventListener('click', () => renderPropRow('motor', null, {}, true));

        el.tubeCsvUpload.addEventListener('change', e => processCsv(e.target.files[0], 'tube'));
        el.addTubeBtn.addEventListener('click', () => renderPropRow('tube', null, {}, true));

        function processCsv(file, type) {
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const rows = e.target.result.split(/\r?\n/).filter(r => r.trim());
                const data = [];
                rows.slice(1).forEach(row => {
                    const cols = row.split(',').map(c => c.trim());
                    const safeFloat = (str) => parseFloat(str.replace(',', '.'));
                    
                    if(type === 'fabric' && cols.length >= 4) data.push({ fabricName: cols[0], fabricWeight: safeFloat(cols[1]), fabricWidth: parseInt(cols[2]), canTurn: cols[3] });
                    if(type === 'motor' && cols.length >= 8) data.push({ motorName: cols[0], torque: safeFloat(cols[1]), blindType: cols[2], adapterKit: cols[3], accessories: cols[4], otherDependencies: cols[5], blindControl: cols[6], controlOptions: cols[7] });
                    if(type === 'tube' && cols.length >= 2) data.push({ blindType: cols[0], tubeDiameter: parseInt(cols[1]) });
                });
                
                const batch = writeBatch(db);
                const snap = await getDocs(collection(db, `orderbot_${type}_properties`));
                snap.forEach(d => batch.delete(d.ref));
                data.forEach(d => batch.set(doc(collection(db, `orderbot_${type}_properties`)), d));
                await batch.commit();
                loadProperties(type);
            };
            reader.readAsText(file);
        }

        async function loadProperties(type) {
             if(!db) return;
             const list = document.getElementById(`${type}-properties-list`);
             list.innerHTML = '<div class="text-center p-4"><div class="loader mx-auto"></div><span class="text-xs text-slate-400">Loading...</span></div>';
             
             try {
                 const snap = await getDocs(collection(db, `orderbot_${type}_properties`));
                 list.innerHTML = '';
                 if(snap.empty) {
                     list.innerHTML = '<p class="text-center text-slate-400 italic text-sm p-4">No properties found in database.</p>';
                     return;
                 }
                 snap.forEach(d => renderPropRow(type, d.id, d.data()));
             } catch(e) {
                 console.error(e);
                 list.innerHTML = '<p class="text-center text-red-500 text-sm p-4">Failed to load properties.</p>';
             }
        }

        function renderPropRow(type, id, data, isNew=false) {
            const div = document.createElement('div');
            div.className = 'grid gap-2 p-2 bg-slate-50 dark:bg-slate-900 rounded mb-2 text-sm items-center border border-slate-200 dark:border-slate-700';
            div.style.gridTemplateColumns = type === 'motor' ? 'repeat(8, 1fr) auto' : type === 'fabric' ? '2fr 1fr 1fr 1fr auto' : '2fr 1fr auto';
            
            const mkInput = (val, ph) => `<input class="w-full p-1.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-xs" value="${val||''}" placeholder="${ph}">`;
            
            let inputs = '';
            if(type === 'fabric') inputs = `${mkInput(data.fabricName,'Name')}${mkInput(data.fabricWeight,'Weight')}${mkInput(data.fabricWidth,'Width')}${mkInput(data.canTurn,'Turn')}`;
            if(type === 'motor') inputs = `${mkInput(data.motorName,'Name')}${mkInput(data.torque,'Torque')}${mkInput(data.blindType,'Blind')}${mkInput(data.adapterKit,'Adapter')}${mkInput(data.accessories,'Acc')}${mkInput(data.otherDependencies,'Dep')}${mkInput(data.blindControl,'Ctrl')}${mkInput(data.controlOptions,'Opt')}`;
            if(type === 'tube') inputs = `${mkInput(data.blindType,'Blind Type')}${mkInput(data.tubeDiameter,'Diameter')}`;

            div.innerHTML = `${inputs}<div class="flex gap-1"><button class="text-green-600 hover:text-green-800 save-btn px-1">â</button><button class="text-red-600 hover:text-red-800 del-btn px-1">â</button></div>`;
            
            div.querySelector('.save-btn').onclick = async () => {
                 const vals = Array.from(div.querySelectorAll('input')).map(i => i.value);
                 let obj = {};
                 if(type === 'fabric') obj = { fabricName: vals[0], fabricWeight: parseFloat(vals[1]), fabricWidth: parseInt(vals[2]), canTurn: vals[3] };
                 if(type === 'motor') obj = { motorName: vals[0], torque: parseFloat(vals[1]), blindType: vals[2], adapterKit: vals[3], accessories: vals[4], otherDependencies: vals[5], blindControl: vals[6], controlOptions: vals[7] };
                 if(type === 'tube') obj = { blindType: vals[0], tubeDiameter: parseInt(vals[1]) };
                 
                 if(isNew) await addDoc(collection(db, `orderbot_${type}_properties`), obj);
                 else await updateDoc(doc(db, `orderbot_${type}_properties`, id), obj);
                 loadProperties(type);
            };
            div.querySelector('.del-btn').onclick = async () => {
                if(!isNew && confirm('Delete?')) await deleteDoc(doc(db, `orderbot_${type}_properties`, id));
                if(!isNew) loadProperties(type); else div.remove();
            };
            
            document.getElementById(`${type}-properties-list`).appendChild(div);
        }

        async function getFabricProperties() {
            if(!db) return new Map();
            const s = await getDocs(collection(db, 'orderbot_fabric_properties'));
            const m = new Map(); s.forEach(d => m.set(d.data().fabricName.toLowerCase().trim(), d.data())); return m;
        }
        async function getMotorProperties() {
            if(!db) return [];
            const s = await getDocs(collection(db, 'orderbot_motor_properties'));
            return s.docs.map(d => d.data());
        }
        async function getTubeProperties() {
            if(!db) return new Map();
            const s = await getDocs(collection(db, 'orderbot_tube_properties'));
            const m = new Map(); s.forEach(d => m.set(d.data().blindType.toLowerCase().trim(), d.data())); return m;
        }

        async function enhanceText(text, model) { 
             const resp = await fetch(PROXY_API_URL, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ model, payload: { contents: [{ parts: [{ text: `Refine this rule into a clear instruction: "${text}"` }] }] } }) });
             const j = await resp.json(); return j.candidates[0].content.parts[0].text;
        }

        // Initial Loads
        addNewPair();
        loadRules();
        loadProperties('fabric');
        loadProperties('motor');
        loadProperties('tube');

    </script>
</body>
</html>
