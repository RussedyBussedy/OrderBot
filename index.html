<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrderBot - Document Comparison with Learning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            min-height: 120px;
        }
        .drop-zone.drag-over { background-color: #e2e8f0; border-color: #4f46e5; }
        .file-item, .history-item { animation: fadeIn 0.5s ease-in-out; }
        .modal-backdrop { animation: fadeIn 0.3s ease-out; }
        .modal-content { animation: slideInUp 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .loader {
            border: 4px solid #f3f4f6; border-top: 4px solid #4f46e5; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .reportable-cell:hover { background-color: #eef2ff !important; cursor: pointer; }
        .spec-text { cursor: pointer; padding: 2px 4px; border-radius: 4px; display: inline-block; }
        .spec-text:hover { background-color: rgba(79, 70, 229, 0.1); }
        .spec-match { color: #166534; }
        .spec-mismatch { color: #b91c1c; font-weight: 600; }
        .spec-low-confidence { color: #b45309; }
        .tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background-color: #1e293b; color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 0.75rem; white-space: nowrap; opacity: 0; visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s; z-index: 10;
        }
        .reportable-cell:hover .tooltip, .spec-text:hover .tooltip { opacity: 1; visibility: visible; }
        #feedback-image-preview { position: absolute; top: 8px; left: 8px; max-height: 60px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .summary-item-details, .sundry-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .active-tab { border-bottom-color: #4f46e5; color: #4f46e5; }
        .rule-row { animation: fadeIn 0.3s ease-in-out; }
        .logic-operator { position: relative; }
        .logic-operator::before {
            content: ''; position: absolute; left: 50%; top: -10px; bottom: -10px; width: 2px;
            background-color: #e2e8f0; z-index: 0; transform: translateX(-50%);
        }
        .logic-badge { position: relative; z-index: 1; }
        #error-console { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="error-console" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 mx-4 mt-4 rounded shadow-md">
        <p class="font-bold">System Error</p>
        <p id="error-message">Something went wrong.</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="bg-white p-4 rounded-lg mb-8 flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-4">
                <svg class="w-12 h-12 text-slate-800" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="30" cy="30" r="28" stroke="currentColor" stroke-width="2.5"/>
                      <path d="M18 20 H42" stroke="currentColor" stroke-width="2.5"/>
                      <path d="M18 25 H42" stroke="currentColor" stroke-width="2.5"/>
                      <path d="M18 30 H42" stroke="currentColor" stroke-width="2.5"/>
                      <path d="M18 35 H42" stroke="currentColor" stroke-width="2.5"/>
                      <path d="M18 40 H42" stroke="currentColor" stroke-width="2.5"/>
                </svg>
                <div>
                      <h1 class="text-2xl font-bold text-slate-800 tracking-wider">BLIND DESIGNS</h1>
                      <p class="text-xs text-slate-500 tracking-[0.25em]">REFLECT YOUR STYLE</p>
                </div>
            </div>
            <div class="text-right">
                <h2 class="text-2xl font-bold text-slate-900">OrderBot</h2>
                <p class="text-sm text-slate-600">Comparison Tool</p>
            </div>
        </header>

        <main>
             <div class="mb-8 bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="flex border-b border-slate-200 overflow-x-auto">
                    <button class="tab-btn flex-1 py-4 px-4 text-sm font-bold text-slate-500 hover:text-slate-700 border-b-2 border-transparent hover:border-slate-300 focus:outline-none whitespace-nowrap" data-target="guidelines-panel">AI Guidelines</button>
                    <button class="tab-btn flex-1 py-4 px-4 text-sm font-bold text-slate-500 hover:text-slate-700 border-b-2 border-transparent hover:border-slate-300 focus:outline-none whitespace-nowrap" data-target="fabric-panel">Fabric Properties</button>
                    <button class="tab-btn flex-1 py-4 px-4 text-sm font-bold text-slate-500 hover:text-slate-700 border-b-2 border-transparent hover:border-slate-300 focus:outline-none whitespace-nowrap" data-target="motor-panel">Motor Properties</button>
                    <button class="tab-btn flex-1 py-4 px-4 text-sm font-bold text-slate-500 hover:text-slate-700 border-b-2 border-transparent hover:border-slate-300 focus:outline-none whitespace-nowrap" data-target="tube-panel">Tube Properties</button>
                    <button class="tab-btn flex-1 py-4 px-4 text-sm font-bold text-slate-500 hover:text-slate-700 border-b-2 border-transparent hover:border-slate-300 focus:outline-none whitespace-nowrap" data-target="history-panel" id="history-tab-btn">Order History</button>
                </div>

                <div>
                    <div id="guidelines-panel" class="tab-content hidden p-6 bg-slate-50">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                             <h3 class="font-bold text-lg text-slate-800">Custom Rules</h3>
                             <div class="flex gap-2">
                                 <button id="open-rule-builder-btn" class="bg-white text-indigo-600 border border-indigo-200 font-bold py-2 px-4 rounded-lg hover:bg-indigo-50 transition-colors text-sm flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 01-1.043 3.296 3.745 3.745 0 01-3.296 1.043A3.745 3.745 0 0112 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 01-3.296-1.043 3.745 3.745 0 01-1.043-3.296A3.745 3.745 0 013 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 011.043-3.296 3.746 3.746 0 013.296-1.043A3.746 3.746 0 0112 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 013.296 1.043 3.746 3.746 0 011.043 3.296A3.745 3.745 0 0121 12z" /></svg> Logic Rule Builder
                                 </button>
                                 <button id="add-guideline-btn" class="bg-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg hover:bg-indigo-200 transition-colors text-sm">Add Sentence</button>
                             </div>
                         </div>
                        <div id="guidelines-list" class="text-sm text-slate-600 space-y-2"></div>
                    </div>

                    <div id="fabric-panel" class="tab-content hidden p-6 bg-slate-50">
                         <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h3 class="font-bold text-lg text-slate-800">Fabric Database</h3>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button id="add-fabric-btn" class="bg-green-100 text-green-700 font-bold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors text-sm whitespace-nowrap">+ Add New</button>
                            </div>
                         </div>
                         <label id="fabric-csv-drop-zone" class="drop-zone !min-h-0 p-4 mb-3 rounded-lg flex flex-col items-center justify-center cursor-pointer bg-white shadow-sm text-center border border-dashed border-slate-300 hover:bg-slate-50">
                            <h3 class="text-sm font-semibold text-slate-700">Upload CSV to Replace All</h3>
                            <p class="text-xs text-slate-500">Drag & drop new CSV here, or click to upload</p>
                            <input type="file" id="fabric-csv-upload" class="hidden" accept=".csv">
                        </label>
                        <div id="fabric-properties-list" class="space-y-2 max-h-[500px] overflow-y-auto pr-2"></div>
                    </div>

                    <div id="motor-panel" class="tab-content hidden p-6 bg-slate-50">
                        <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h3 class="font-bold text-lg text-slate-800">Motor Database</h3>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button id="add-motor-btn" class="bg-green-100 text-green-700 font-bold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors text-sm whitespace-nowrap">+ Add New</button>
                            </div>
                         </div>
                         <label id="motor-csv-drop-zone" class="drop-zone !min-h-0 p-4 mb-3 rounded-lg flex flex-col items-center justify-center cursor-pointer bg-white shadow-sm text-center border border-dashed border-slate-300 hover:bg-slate-50">
                            <h3 class="text-sm font-semibold text-slate-700">Upload CSV to Replace All</h3>
                            <p class="text-xs text-slate-500">Drag & drop new CSV here, or click to upload</p>
                            <input type="file" id="motor-csv-upload" class="hidden" accept=".csv">
                        </label>
                        <div id="motor-properties-list" class="space-y-2 max-h-[500px] overflow-y-auto pr-2"></div>
                    </div>
                    
                    <div id="tube-panel" class="tab-content hidden p-6 bg-slate-50">
                         <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <h3 class="font-bold text-lg text-slate-800">Tube Database</h3>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button id="add-tube-btn" class="bg-green-100 text-green-700 font-bold py-2 px-4 rounded-lg hover:bg-green-200 transition-colors text-sm whitespace-nowrap">+ Add New</button>
                            </div>
                         </div>
                         <label id="tube-csv-drop-zone" class="drop-zone !min-h-0 p-4 mb-3 rounded-lg flex flex-col items-center justify-center cursor-pointer bg-white shadow-sm text-center border border-dashed border-slate-300 hover:bg-slate-50">
                            <h3 class="text-sm font-semibold text-slate-700">Upload CSV to Replace All</h3>
                            <p class="text-xs text-slate-500">Drag & drop new CSV here, or click to upload</p>
                            <input type="file" id="tube-csv-upload" class="hidden" accept=".csv">
                        </label>
                        <div id="tube-properties-list" class="space-y-2 max-h-[500px] overflow-y-auto pr-2"></div>
                    </div>

                    <div id="history-panel" class="tab-content hidden p-6 bg-slate-50">
                        <div class="mb-8 bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                            <h3 class="font-bold text-lg text-slate-800 mb-3">Search Archives</h3>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input type="text" id="history-search-input" class="w-full sm:w-auto flex-grow p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Search by Order Number (Press Enter)">
                                <button id="history-search-btn" class="bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-700 transition-colors">Find History</button>
                                <button id="clear-history-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors hidden">Clear</button>
                            </div>
                            <div id="history-results" class="mt-4 space-y-4"></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg text-slate-800">Comparisons Run Today</h3>
                                <button id="refresh-daily-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg> Refresh
                                </button>
                            </div>
                            <div id="daily-history-list" class="space-y-3">
                                <div class="text-center py-8 text-slate-400 italic">Loading today's activity...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="upload-section">
                <div id="upload-pairs-container" class="space-y-6"></div>
                <div class="mt-6 flex justify-center">
                    <button id="add-pair-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">+ Add Another Order</button>
                </div>
                <div class="text-center mt-8 mb-8">
                    <button id="compare-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors" disabled>Run Comparisons</button>
                </div>
            </div>

            <div id="report-section" class="bg-white rounded-lg shadow-md p-6 md:p-8 hidden">
                <div id="report-actions" class="flex justify-between items-center mb-6 border-b pb-4">
                      <h2 class="text-2xl font-bold text-slate-900">Comparison Summary</h2>
                      <button id="new-comparison-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors hidden">Start New Comparison</button>
                </div>
                <div id="report-content"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="guideline-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg">
             <div class="p-6 border-b"><h3 class="text-xl font-semibold text-slate-800">Add New Guideline (Natural Language)</h3><p class="text-sm text-slate-500">Add a rule in plain English.</p></div>
             <div class="p-6"><label for="guideline-input" class="block text-sm font-medium text-slate-700 mb-2">Describe the rule:</label><textarea id="guideline-input" rows="4" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 1. If the location is 'Kitchen', the material must be water-resistant."></textarea></div>
             <div class="px-6 py-4 bg-slate-50 rounded-b-lg flex justify-end gap-3"><button id="cancel-guideline-btn" class="bg-white text-slate-700 font-semibold py-2 px-4 rounded-md border border-slate-300 hover:bg-slate-100">Cancel</button><button id="save-guideline-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">Save Guideline</button></div>
        </div>
    </div>

    <div id="rule-builder-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b bg-slate-50 rounded-t-lg flex justify-between items-center">
                <div><h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">Logic Rule Builder</h3><p class="text-sm text-slate-500">Construct precise rules for the AI to follow.</p></div>
                <button id="close-rule-builder-btn" class="text-slate-400 hover:text-slate-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-slate-50/50">
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm mb-4">
                    <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wide mb-3 border-b pb-2">IF (Conditions)</h4>
                    <div id="rb-conditions-container" class="space-y-0"></div>
                    <button id="rb-add-condition-btn" class="mt-4 text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center gap-1">Add Condition</button>
                </div>
                <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm mb-4">
                    <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wide mb-3 border-b pb-2">THEN (Action)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-xs font-semibold text-slate-500 mb-1">Action Type</label><select id="rb-action-type" class="w-full p-2 border border-slate-300 rounded text-sm bg-slate-50"><option value="MUST MATCH">Must Match / Be Equal To</option><option value="FLAG WARNING">Flag a Warning (Yellow)</option><option value="FLAG CRITICAL">Flag a Critical Error (Red)</option><option value="REQUIRE">Require specific component/value</option><option value="FORBID">Forbid/Disallow</option></select></div>
                        <div><label class="block text-xs font-semibold text-slate-500 mb-1">Message / Value</label><input type="text" id="rb-action-value" class="w-full p-2 border border-slate-300 rounded text-sm" placeholder="e.g., 'Motor must be Somfy'"></div>
                    </div>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                    <h4 class="text-xs font-bold text-indigo-800 uppercase tracking-wide mb-1">Generated Rule Preview</h4>
                    <p id="rb-preview-text" class="text-sm text-indigo-900 font-medium italic">IF ... THEN ...</p>
                </div>
            </div>
            <div class="p-6 border-t bg-white rounded-b-lg flex justify-end gap-3"><button id="rb-cancel-btn" class="bg-white text-slate-700 font-semibold py-2 px-4 rounded-md border border-slate-300 hover:bg-slate-100">Cancel</button><button id="rb-save-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-md hover:bg-indigo-700 shadow-md">Save Rule</button></div>
        </div>
    </div>

    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg">
            <div class="p-6 border-b"><h3 id="feedback-modal-title" class="text-xl font-semibold text-slate-800">Report an Error</h3><p class="text-sm text-slate-500">Help OrderBot learn by explaining what it got wrong.</p></div>
            <div class="p-6 space-y-4">
                <div class="bg-slate-50 p-4 rounded-md"><h4 class="font-semibold text-slate-700">Incorrect Data:</h4><pre id="incorrect-item-details" class="text-sm text-slate-600 whitespace-pre-wrap font-mono"></pre></div>
                <div id="feedback-textarea-container">
                    <label for="feedback-explanation" class="block text-sm font-medium text-slate-700 mb-2">What is the correct interpretation? (You can paste an image)</label>
                    <div id="feedback-image-container" class="hidden relative w-max"><img id="feedback-image-preview" src="" alt="Pasted snippet"><div id="feedback-image-delete" title="Remove image">&times;</div></div>
                    <textarea id="feedback-explanation" rows="4" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Explanation..."></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 rounded-b-lg flex justify-end gap-3"><button id="cancel-feedback-btn" class="bg-white text-slate-700 font-semibold py-2 px-4 rounded-md border border-slate-300 hover:bg-slate-100">Cancel</button><button id="submit-feedback-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">Submit Feedback</button></div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4 modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 text-center"><h3 id="confirm-modal-title" class="text-lg font-semibold text-slate-800">Are you sure?</h3><p id="confirm-modal-body" class="text-sm text-slate-500 mt-2">This action cannot be undone.</p></div>
            <div class="px-6 py-4 bg-slate-50 rounded-b-lg flex justify-center gap-3"><button id="confirm-modal-cancel" class="bg-white text-slate-700 font-semibold py-2 px-4 rounded-md border border-slate-300 hover:bg-slate-100">Cancel</button><button id="confirm-modal-confirm" class="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700">Confirm</button></div>
        </div>
    </div>
    
    <template id="upload-pair-template">
        <div class="upload-pair border-t-2 pt-6">
            <div class="grid md:grid-cols-2 gap-8">
                <div class="drop-zone rounded-lg p-4 text-center cursor-pointer bg-white shadow-sm">
                    <div class="flex flex-col items-center justify-center h-full"><h3 class="text-lg font-semibold text-slate-700">Customer Order(s)</h3><p class="text-sm text-slate-500">Drag & drop or click</p><input type="file" class="hidden customer-file-input" multiple accept=".pdf,.jpg,.jpeg,.png"></div><ul class="mt-2 text-left customer-file-list"></ul>
                </div>
                <div class="drop-zone rounded-lg p-4 text-center cursor-pointer bg-white shadow-sm">
                    <div class="flex flex-col items-center justify-center h-full"><h3 class="text-lg font-semibold text-slate-700">Blind IQ Order(s)</h3><p class="text-sm text-slate-500">Drag & drop or click</p><input type="file" class="hidden blindiq-file-input" multiple accept=".pdf,.jpg,.jpeg,.png"></div><ul class="mt-2 text-left blindiq-file-list"></ul>
                </div>
            </div>
        </div>
    </template>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc, writeBatch, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3x__sOsj8EPS9KnpweD6uWIhVt9ACNBM",
            authDomain: "orderbot-2b212.firebaseapp.com",
            projectId: "orderbot-2b212",
            storageBucket: "orderbot-2b212.firebasestorage.app",
            messagingSenderId: "51064902388",
            appId: "1:51064902388:web:20d2d93c682a537ebc04a1",
            measurementId: "G-5RM4TC6BD6"
        };
        const PROXY_API_URL = 'https://gemini-secure-proxy-51064902388.africa-south1.run.app';

        function logError(msg) {
            console.error(msg);
            const consoleDiv = document.getElementById('error-console');
            const msgP = document.getElementById('error-message');
            if(consoleDiv && msgP) {
                consoleDiv.style.display = 'block';
                msgP.textContent = msg;
            }
        }
        
        const fileToB64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve({ name: file.name, type: file.type, data: reader.result.split(',')[1] });
            reader.onerror = (error) => reject(error);
        });

        document.addEventListener('DOMContentLoaded', async () => {
            let app, db, auth, userId;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'orderbot-default';

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                userId = auth.currentUser?.uid;
                console.log("Firebase initialized. UID:", userId);
            } catch (error) {
                logError("Firebase Init Failed: " + error.message);
                return; 
            }

            function getCollectionRef(collectionName) {
                return collection(db, `orderbot_${collectionName}`);
            }

            let comparisonPairs = [];
            let itemToCorrect = null, pastedImageB64 = null;
            let historyDataCache = [];
            let summaryResultsCache = [];
            let confirmCallback = null;
            
            let ruleBuilderState = { conditions: [], actionType: 'MUST MATCH', actionValue: '' };
            const RULE_FIELDS = ['Blind Type', 'Location', 'QTY', 'Width', 'Drop', 'Colour', 'Control', 'Range (Fabric)', 'Fix', 'Order Number'];
            const RULE_OPERATORS = [{ val: 'EQUALS', label: 'Equals (=)' }, { val: 'DOES NOT EQUAL', label: 'Does Not Equal (!=)' }, { val: 'CONTAINS', label: 'Contains' }, { val: 'DOES NOT CONTAIN', label: 'Does Not Contain' }, { val: 'STARTS WITH', label: 'Starts With' }, { val: 'IS GREATER THAN', label: 'Is Greater Than (>)' }, { val: 'IS LESS THAN', label: 'Is Less Than (<)' }, { val: 'IS EMPTY', label: 'Is Empty' }];
            const BLIND_TYPE_EXCLUSIONS_FOR_COLOUR_CHECK = ['element double roller', 'curtain glide curtain ripple', 'curtain somfy', 'curtain motion'];
            const BLIND_TYPES_REQUIRING_CONTROL_VALIDATION = ['element roller', 'roller system 40', 'roller system 55', 'element vison', 'vision blind', 'romashade', 'outdoor channel x', 'outdoor free hang', 'outdoor zip x', 'outdoor wire x', 'outdoor widescreen'];

            const allDomElements = {
                uploadPairsContainer: document.getElementById('upload-pairs-container'),
                addPairBtn: document.getElementById('add-pair-btn'),
                uploadPairTemplate: document.getElementById('upload-pair-template'),
                compareBtn: document.getElementById('compare-btn'),
                reportSection: document.getElementById('report-section'),
                reportContent: document.getElementById('report-content'),
                feedbackModal: document.getElementById('feedback-modal'),
                feedbackModalTitle: document.getElementById('feedback-modal-title'),
                incorrectItemDetails: document.getElementById('incorrect-item-details'),
                feedbackExplanation: document.getElementById('feedback-explanation'),
                cancelFeedbackBtn: document.getElementById('cancel-feedback-btn'),
                submitFeedbackBtn: document.getElementById('submit-feedback-btn'),
                feedbackTextareaContainer: document.getElementById('feedback-textarea-container'),
                feedbackImageContainer: document.getElementById('feedback-image-container'),
                feedbackImagePreview: document.getElementById('feedback-image-preview'),
                feedbackImageDelete: document.getElementById('feedback-image-delete'),
                historySection: document.getElementById('history-section'),
                historySearchInput: document.getElementById('history-search-input'),
                historySearchBtn: document.getElementById('history-search-btn'),
                historyResults: document.getElementById('history-results'),
                clearHistoryBtn: document.getElementById('clear-history-btn'),
                historyPanel: document.getElementById('history-panel'),
                dailyHistoryList: document.getElementById('daily-history-list'),
                refreshDailyBtn: document.getElementById('refresh-daily-btn'),
                historyTabBtn: document.getElementById('history-tab-btn'),
                uploadSection: document.getElementById('upload-section'),
                newComparisonBtn: document.getElementById('new-comparison-btn'),
                guidelineModal: document.getElementById('guideline-modal'),
                addGuidelineBtn: document.getElementById('add-guideline-btn'),
                cancelGuidelineBtn: document.getElementById('cancel-guideline-btn'),
                saveGuidelineBtn: document.getElementById('save-guideline-btn'),
                guidelineInput: document.getElementById('guideline-input'),
                guidelinesList: document.getElementById('guidelines-list'),
                ruleBuilderModal: document.getElementById('rule-builder-modal'),
                openRuleBuilderBtn: document.getElementById('open-rule-builder-btn'),
                closeRuleBuilderBtn: document.getElementById('close-rule-builder-btn'),
                rbConditionsContainer: document.getElementById('rb-conditions-container'),
                rbAddConditionBtn: document.getElementById('rb-add-condition-btn'),
                rbActionType: document.getElementById('rb-action-type'),
                rbActionValue: document.getElementById('rb-action-value'),
                rbPreviewText: document.getElementById('rb-preview-text'),
                rbCancelBtn: document.getElementById('rb-cancel-btn'),
                rbSaveBtn: document.getElementById('rb-save-btn'),
                fabricPropertiesList: document.getElementById('fabric-properties-list'),
                fabricCsvUpload: document.getElementById('fabric-csv-upload'),
                fabricCsvDropZone: document.getElementById('fabric-csv-drop-zone'),
                addFabricBtn: document.getElementById('add-fabric-btn'),
                motorPropertiesList: document.getElementById('motor-properties-list'),
                motorCsvUpload: document.getElementById('motor-csv-upload'),
                motorCsvDropZone: document.getElementById('motor-csv-drop-zone'),
                addMotorBtn: document.getElementById('add-motor-btn'),
                tubePropertiesList: document.getElementById('tube-properties-list'),
                tubeCsvUpload: document.getElementById('tube-csv-upload'),
                tubeCsvDropZone: document.getElementById('tube-csv-drop-zone'),
                addTubeBtn: document.getElementById('add-tube-btn'),
                confirmModal: document.getElementById('confirm-modal'),
                confirmModalTitle: document.getElementById('confirm-modal-title'),
                confirmModalBody: document.getElementById('confirm-modal-body'),
                confirmModalCancel: document.getElementById('confirm-modal-cancel'),
                confirmModalConfirm: document.getElementById('confirm-modal-confirm'),
            };

            if(!allDomElements.uploadPairsContainer) { logError("Critical Error: DOM Elements missing."); return; }

            // ==========================================
            // 1. DEFINE ALL FUNCTIONS FIRST (ORDERED FOR DEPENDENCY)
            // ==========================================

            function showConfirmModal(message, onConfirm) {
                allDomElements.confirmModalBody.textContent = message;
                confirmCallback = onConfirm;
                allDomElements.confirmModal.style.display = 'flex';
            }
            
            function addNewPair() {
                if (comparisonPairs.length >= 10) { allDomElements.addPairBtn.disabled = true; return; }
                const newPair = { customerFiles: [], blindIQFiles: [] };
                comparisonPairs.push(newPair);
                const index = comparisonPairs.length - 1;
                const template = allDomElements.uploadPairTemplate.content.cloneNode(true);
                const pairElement = template.querySelector('.upload-pair');
                pairElement.dataset.index = index;
                const dropZones = pairElement.querySelectorAll('.drop-zone');
                const inputs = pairElement.querySelectorAll('input[type="file"]');
                const lists = pairElement.querySelectorAll('ul');
                if(dropZones.length >= 2) {
                     setupDropZone(dropZones[0], inputs[0], lists[0], newPair.customerFiles);
                     setupDropZone(dropZones[1], inputs[1], lists[1], newPair.blindIQFiles);
                }
                allDomElements.uploadPairsContainer.appendChild(pairElement); 
                checkCompareButtonState();
            }

            async function loadAndDisplayGuidelines() {
                if (!db) return;
                const q = query(getCollectionRef('guidelines'));
                const querySnapshot = await getDocs(q);
                allDomElements.guidelinesList.innerHTML = '';
                if (querySnapshot.empty) {
                    allDomElements.guidelinesList.innerHTML = '<p class="text-slate-400 italic">No custom guidelines have been added yet.</p>';
                    return;
                }
                querySnapshot.forEach(doc => {
                    const guidelineData = doc.data();
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-indigo-50 p-2 rounded mb-2';
                    div.innerHTML = `<span class="text-sm text-slate-700">- ${guidelineData.enhancedGuideline}</span><button data-id="${doc.id}" class="delete-guideline-btn text-red-400 hover:text-red-600 font-bold ml-2 text-lg">&times;</button>`;
                    allDomElements.guidelinesList.appendChild(div);
                });
            }
            
            async function processSingleComparison(pair) {
                const { customerFiles, blindIQFiles } = pair;
                let feedbackExamples = "";
                let guidelines = "";

                if (db) {
                    const feedbackQuery = query(getCollectionRef('feedback'));
                    const guidelineQuery = query(getCollectionRef('guidelines'));
                    const [feedbackSnapshot, guidelineSnapshot] = await Promise.all([getDocs(feedbackQuery), getDocs(guidelineQuery)]);
                    
                    const feedbackDocs = [];
                    feedbackSnapshot.forEach(doc => feedbackDocs.push(doc.data()));
                    if (feedbackDocs.length > 0) {
                        feedbackDocs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        feedbackExamples = "\n## 5. CORRECTION EXAMPLES (LEARNING)\n" + feedbackDocs.slice(0, 10).map((fb, i) => `Example ${i + 1}:\n- Incorrect Item: ${JSON.stringify(fb.incorrectItem)}\n- Enhanced Explanation: "${fb.enhancedExplanation}"\n`).join("\n");
                    }

                    const guidelineDocs = [];
                    guidelineSnapshot.forEach(doc => guidelineDocs.push(doc.data().enhancedGuideline));
                    if (guidelineDocs.length > 0) {
                        guidelines = "\n## 6. USER-DEFINED GUIDELINES (CRITICAL)\nYou must follow these rules without exception:\n- " + guidelineDocs.join("\n- ") + "\n";
                    }
                }

                const systemPrompt = `
                    # OrderBot - System Prompt
                    ## 1. IDENTITY & PERSONA: You are OrderBot, an AI assistant.
                    ## 2. CORE DIRECTIVE: Analyze 'customer' vs 'blindiq' files, extract parameters, compare them, and return a structured JSON report.
                    ## 3. DATA EXTRACTION & ANALYSIS LOGIC:
                    - You may receive one customer document and multiple Blind IQ documents. Your task is to treat all Blind IQ documents as a single, consolidated order and compare all of their combined line items against the single customer document.
                    - For each line item in the 'Blinds' table, extract the primary fields: Item, Location, QTY, Width, Drop, Colour, Control, Blind Type, Range, and Fix. The 'Item' should correspond to the alphabetical identifier (A, B, C...).
                    - You MUST also extract and compare all items from the 'Sundries' table against the customer document. Each sundry item has a description and a quantity. It is common for these items not to appear on the customer order; in this case, the result should be 'OMISSION'.
                    - The 'Range' field corresponds to the fabric name. You MUST extract this value from the Blind IQ document only.
                    - The 'Colour' field is often empty for certain Blind Types. You must accurately extract the colour if present, or an empty string "" if it is not.
                    - CRITICAL: Look for a secondary line of text below the primary fields in the 'Blinds' table. This line contains detailed specifications separated by '|' and using '='. You MUST parse this line.
                    - Compare all primary fields, all parsed specifications, and the special instructions between the two documents.
                    ## 4. JSON OUTPUT STRUCTURE: Respond ONLY with a single JSON object conforming to the schema.
                    ${guidelines}
                    ${feedbackExamples}
                `;

                const parts = [{ text: systemPrompt }];
                
                const customerFilePromises = customerFiles.map(fileToB64);
                const blindIQFilePromises = blindIQFiles.map(fileToB64);
                const [customerB64FileObjects, blindIQB64FileObjects] = await Promise.all([
                    Promise.all(customerFilePromises),
                    Promise.all(blindIQFilePromises)
                ]);

                for (const fileObj of customerB64FileObjects) {
                    parts.push({ text: `\n--- START CUSTOMER FILE: ${fileObj.name} ---` });
                    parts.push({ inlineData: { mimeType: fileObj.type, data: fileObj.data } });
                }
                for (const fileObj of blindIQB64FileObjects) {
                    parts.push({ text: `\n--- START BLIND IQ FILE: ${fileObj.name} ---` });
                    parts.push({ inlineData: { mimeType: fileObj.type, data: fileObj.data } });
                }

                const comparisonFieldSchema = { type: "OBJECT", properties: { "customerValue": { "type": "STRING" }, "blindIQValue": { "type": "STRING" }, "result": { "type": "STRING", "enum": ["MATCH", "MISMATCH", "OMISSION", "NOTE"] }, "confidence": { "type": "NUMBER" } }, required: ["customerValue", "blindIQValue", "result", "confidence"] };
                const schema = {
                    type: "OBJECT",
                    properties: {
                        "bdoOrderNumber": { "type": "STRING" },
                        "customerOrderNumber": comparisonFieldSchema,
                        "specialInstructions": comparisonFieldSchema,
                        "lineItems": {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "item": comparisonFieldSchema,
                                    "location": comparisonFieldSchema,
                                    "qty": comparisonFieldSchema,
                                    "width": comparisonFieldSchema,
                                    "drop": comparisonFieldSchema,
                                    "colour": comparisonFieldSchema,
                                    "control": comparisonFieldSchema,
                                    "blindType": comparisonFieldSchema,
                                    "range": comparisonFieldSchema,
                                    "fix": comparisonFieldSchema,
                                    "specifications": {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: {
                                                "specName": { "type": "STRING" },
                                                "specComparison": comparisonFieldSchema
                                            },
                                            required: ["specName", "specComparison"]
                                        }
                                    }
                                },
                                required: ["item", "location", "qty", "width", "drop", "colour", "control", "blindType", "range", "fix"]
                            }
                        },
                        "sundries": {
                            type: "ARRAY",
                            items: {
                            type: "OBJECT",
                                properties: {
                                    "item": comparisonFieldSchema,
                                    "quantity": { "type": "NUMBER" }
                                },
                                required: ["item", "quantity"]
                            }
                        }
                    },
                    required: ["bdoOrderNumber", "customerOrderNumber", "lineItems"]
                };

                const geminiPayload = { contents: [{ role: "user", parts: parts }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                const proxyPayload = { model: 'gemini-3-pro-preview', payload: geminiPayload };
                const response = await fetch(PROXY_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(proxyPayload) });
                const resultText = await response.text();
                if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText} - ${resultText}`);
                const result = JSON.parse(resultText);
                if (!result.candidates || result.candidates.length === 0 || !result.candidates[0].content) throw new Error("No content.");
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                if (db && data.bdoOrderNumber) {
                    await addDoc(getCollectionRef('comparisons'), { ...data, timestamp: new Date().toISOString(), userId: userId });
                }
                return data;
            }
            
            function renderReportTable(data) {
                const getIndicator = (result) => ({ 'MISMATCH': 'ðŸ”´', 'OMISSION': 'ðŸŸ¡', 'MATCH': 'ðŸŸ¢', 'NOTE': 'ðŸ”µ' }[result] || '');
                const renderCell = (field, fieldName, label) => {
                    const isMismatch = field && field.result === 'MISMATCH';
                    const isLowConfidence = field && (field.confidence * 100) < 90;
                    const value = field ? field.blindIQValue : 'N/A';
                    const customerVal = field ? field.customerValue : 'N/A';
                    let content = value;
                    if (isMismatch) content = `${value} <span class="text-xs font-normal">(vs ${customerVal})</span>`;
                    let cellClasses = 'px-2 py-1 reportable-cell';
                    let textClasses = 'text-sm text-slate-800';
                    let tooltip = '';
                    if (isMismatch) { cellClasses += ' bg-red-50'; textClasses += ' font-bold text-red-700'; } 
                    else if (isLowConfidence) { cellClasses += ' bg-orange-50'; textClasses += ' text-orange-700'; tooltip = `<div class="tooltip">Confidence: ${Math.round(field.confidence * 100)}%</div>`; }
                    return `<div class="${cellClasses}" data-field-name="${fieldName}"><div class="text-xs font-semibold text-slate-500">${label}</div><div class="${textClasses}">${content}</div>${tooltip}</div>`;
                };
                
                let globalValidationHtml = '';
                if (data.motorValidation && data.motorValidation.global) {
                    globalValidationHtml = `<div class="mb-4 p-2 text-sm font-semibold bg-red-100 text-red-800 rounded-lg flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg> ${data.motorValidation.global}</div>`;
                }
    
                const orderNumberRow = `${globalValidationHtml}<div class="mb-4 p-4 rounded-lg ${data.customerOrderNumber.result === 'MATCH' ? 'bg-green-100' : 'bg-red-100'}"><h3 class="font-bold text-lg ${data.customerOrderNumber.result === 'MATCH' ? 'text-green-800' : 'text-red-800'}">Order Number Comparison</h3><p class="text-sm ${data.customerOrderNumber.result === 'MATCH' ? 'text-green-700' : 'text-red-700'}">Customer O/N: <strong>${data.customerOrderNumber.customerValue}</strong> | Blind IQ O/N: <strong>${data.customerOrderNumber.blindIQValue}</strong><span class="font-bold ml-2">${getIndicator(data.customerOrderNumber.result)} ${data.customerOrderNumber.result}</span></p></div>`;
                let specialInstructionsRow = '';
                if (data.specialInstructions && (data.specialInstructions.customerValue || data.specialInstructions.blindIQValue)) {
                    specialInstructionsRow = `<div class="mb-4 p-4 rounded-lg bg-amber-100"><h3 class="font-bold text-lg text-amber-800">Special Instructions</h3><p class="text-sm text-amber-700">Customer Doc: <strong>${data.specialInstructions.customerValue || 'None'}</strong></p><p class="text-sm text-amber-700">Blind IQ Doc: <strong>${data.specialInstructions.blindIQValue || 'None'}</strong></p></div>`;
                }
                
                const lineItemsHtml = (data.lineItems || []).map((lineItem, index) => {
                     let validationHtml = '';
                    if(lineItem.fabricValidation) { const alertClass = lineItem.fabricValidation.type === 'error' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'; validationHtml += `<div class="p-2 text-sm font-semibold ${alertClass} flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg> ${lineItem.fabricValidation.message}</div>`; }
                    if(lineItem.colourValidation) { validationHtml += `<div class="p-2 text-sm font-semibold bg-red-100 text-red-800 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg> ${lineItem.colourValidation.message}</div>`; }
                    if (lineItem.controlValidation) { validationHtml += `<div class="p-2 text-sm font-semibold bg-red-100 text-red-800 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg> ${lineItem.controlValidation.message}</div>`; }
                    if (lineItem.motorValidation && Array.isArray(lineItem.motorValidation)) { lineItem.motorValidation.forEach(msg => { validationHtml += `<div class="p-2 text-sm font-semibold bg-red-100 text-red-800 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg> ${msg}</div>`; }); }
                    if (lineItem.torqueValidation) { const alertClass = lineItem.torqueValidation.type === 'warning' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'; validationHtml += `<div class="p-2 text-sm font-semibold ${alertClass} flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg> ${lineItem.torqueValidation.message}</div>`; } 
                    else if (lineItem.requiredTorque) { validationHtml += `<div class="p-2 text-sm font-semibold bg-blue-100 text-blue-800 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg> RQD Torque: ${lineItem.requiredTorque} Nm</div>`; }

                    const specHtml = (lineItem.specifications || []).map((spec, specIndex) => {
                        const isMismatch = spec.specComparison.result === 'MISMATCH';
                        const isOmission = spec.specComparison.result === 'OMISSION';
                        const isLowConfidence = (spec.specComparison.confidence * 100) < 90;
                        let resultClass = 'spec-match';
                        if (isMismatch) resultClass = 'spec-mismatch';
                        else if (isLowConfidence) resultClass = 'spec-low-confidence';
                        let text = `${spec.specName}=${spec.specComparison.blindIQValue}`;
                        if (isMismatch) text += ` (vs ${spec.specComparison.customerValue})`;
                        if (isOmission) text += ` (Omission)`;
                        let tooltip = '';
                        if (isLowConfidence && !isMismatch) tooltip = `<div class="tooltip">Confidence: ${Math.round(spec.specComparison.confidence * 100)}%</div>`;
                        return `<span class="spec-text ${resultClass}" data-spec-index="${specIndex}">${text}${tooltip}</span>`;
                    }).join(' | ');
    
                    return `<div class="line-item-container border border-slate-200 rounded-lg mb-4" data-row-index="${index}">${validationHtml}<div class="grid grid-cols-10 bg-slate-50 font-semibold text-sm text-slate-700 border-b border-slate-200 divide-x divide-slate-200">${renderCell(lineItem.item, 'item', 'Item')}${renderCell(lineItem.qty, 'qty', 'QTY')}${renderCell(lineItem.location, 'location', 'Location')}${renderCell(lineItem.blindType, 'blindType', 'Blind Type')}${renderCell(lineItem.range, 'range', 'Range')}${renderCell(lineItem.colour, 'colour', 'Colour')}${renderCell(lineItem.width, 'width', 'Width')}${renderCell(lineItem.drop, 'drop', 'Drop')}${renderCell(lineItem.control, 'control', 'Control')}${renderCell(lineItem.fix, 'fix', 'Fix')}</div><div class="p-3 bg-white text-xs text-slate-600">${specHtml}</div></div>`;
                }).join('');
                
                let sundriesHtml = '';
                if (data.sundries && data.sundries.length > 0) {
                    sundriesHtml = '<h3 class="font-bold text-lg text-slate-800 mt-6 mb-2">Sundries Comparison</h3><div class="space-y-2 text-sm">';
                    data.sundries.forEach(sundry => {
                        if (sundry.validationLog) { 
                            const hasErrors = sundry.validationLog.some(log => log.status === 'FAIL');
                            const headerClass = hasErrors ? 'bg-red-50' : 'bg-green-50';
                            const badgeClass = hasErrors ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800';
                            let detailsHtml = '<ul class="p-2 space-y-1 text-xs">';
                            sundry.validationLog.forEach(log => { const icon = log.status === 'PASS' ? '<span class="text-green-500">âœ”</span>' : '<span class="text-red-500">âœ–</span>'; detailsHtml += `<li class="flex items-start gap-2">${icon} <div><strong>${log.check}:</strong> ${log.details}</div></li>`; });
                            detailsHtml += '</ul>';
                            sundriesHtml += `<div class="border rounded-md overflow-hidden"><div class="sundry-header p-2 flex justify-between items-center cursor-pointer ${headerClass}"><span>${sundry.quantity} x ${sundry.item.blindIQValue}</span><span class="text-xs font-bold px-2 py-1 rounded-full ${badgeClass}">${hasErrors ? 'ERRORS FOUND' : 'VALIDATED'}</span></div><div class="sundry-details bg-white border-t">${detailsHtml}</div></div>`;
                        } else { 
                            const result = sundry.item.result;
                            let resultClass = 'text-slate-500';
                            if (result === 'MATCH') resultClass = 'text-green-700';
                            if (result === 'MISMATCH') resultClass = 'text-red-700 font-semibold';
                            sundriesHtml += `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-md"><span>${sundry.quantity} x ${sundry.item.blindIQValue}</span><span class="font-medium ${resultClass}">${result}</span></div>`;
                        }
                    });
                    sundriesHtml += '</div>';
                }
                return `${orderNumberRow}${specialInstructionsRow}${lineItemsHtml}${sundriesHtml}`;
            }
            
            function setupReportInteraction(container, reportData) {
                const reportContainer = container;
                const dataToUse = reportData;
    
                reportContainer.addEventListener('click', (e) => {
                    const target = e.target.closest('.reportable-cell, .spec-text, .sundry-header');
                    if (!target) return;
                    if (target.classList.contains('sundry-header')) {
                        const details = target.nextElementSibling;
                         if (details.style.maxHeight) { details.style.maxHeight = null; } else { details.style.maxHeight = details.scrollHeight + "px"; }
                        return;
                    }
                    if (!db) { alert("Feedback system is not available."); return; }
                    const lineItemElement = target.closest('.line-item-container');
                    if (!lineItemElement) return;
                    const rowIndex = lineItemElement.dataset.rowIndex;
                    const lineItem = dataToUse.lineItems[rowIndex];
                    let fieldName, fieldData;
                    if (target.classList.contains('spec-text')) {
                        const specIndex = target.dataset.specIndex;
                        const spec = lineItem.specifications[specIndex];
                        fieldName = spec.specName; fieldData = spec.specComparison;
                    } else {
                        fieldName = target.dataset.fieldName;
                        fieldData = lineItem[fieldName];
                    }
                    if (!fieldData) return;
                    itemToCorrect = { lineItemIdentifier: { item: lineItem.item.blindIQValue, location: lineItem.location.blindIQValue }, fieldName: fieldName, fieldData: fieldData };
                    allDomElements.feedbackModalTitle.textContent = `Correcting error for: ${fieldName}`;
                    allDomElements.incorrectItemDetails.textContent = JSON.stringify(fieldData, null, 2);
                    allDomElements.feedbackModal.style.display = 'flex';
                });
            }
            
             function renderHistoryList(items, container) {
                if (items.length === 0) {
                    container.innerHTML = `<div class="text-center py-8 bg-slate-50 rounded-lg border border-dashed border-slate-300 text-slate-500 italic">No comparisons found.</div>`;
                    return;
                }
    
                container.innerHTML = '';
                items.forEach((data, index) => {
                    const dateObj = new Date(data.timestamp);
                    const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const dateStr = dateObj.toLocaleDateString();
                    let status = 'MATCH'; let statusColor = 'bg-green-100 text-green-800';
                    let hasMismatch = false; let hasAlert = (data.motorValidation || false);
                    (data.lineItems || []).forEach(item => {
                         if (item.fabricValidation || item.colourValidation || item.motorValidation || item.torqueValidation || item.controlValidation) hasAlert = true;
                         Object.values(item).forEach(field => { if (field && (field.result === 'MISMATCH' || field.result === 'OMISSION')) hasMismatch = true; });
                         (item.specifications || []).forEach(spec => { if (spec.specComparison.result === 'MISMATCH' || spec.specComparison.result === 'OMISSION') hasMismatch = true; });
                    });
                    if (hasMismatch || hasAlert) { status = 'ATTENTION'; statusColor = 'bg-red-100 text-red-800'; }
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'border border-slate-200 rounded-lg overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow';
                    itemDiv.innerHTML = `<div class="history-header p-4 cursor-pointer flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 bg-slate-50 hover:bg-slate-100 transition-colors"><div class="flex items-center gap-3"><div class="bg-indigo-100 text-indigo-600 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg></div><div><h4 class="font-bold text-slate-800 text-sm sm:text-base">${data.bdoOrderNumber || 'Unknown Order'}</h4><div class="text-xs text-slate-500 flex gap-2"><span>${dateStr} at ${timeStr}</span><span>â€¢</span><span>${(data.lineItems || []).length} items</span></div></div></div><div class="flex items-center gap-3"><span class="text-xs font-bold px-2 py-1 rounded-full ${statusColor}">${status}</span><svg class="chevron-icon w-5 h-5 text-slate-400 transform transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg></div></div><div class="history-content hidden border-t border-slate-100 p-4"><!-- Report Content --></div>`;
                    const header = itemDiv.querySelector('.history-header');
                    const content = itemDiv.querySelector('.history-content');
                    const icon = itemDiv.querySelector('.chevron-icon');
                    header.addEventListener('click', () => {
                        const isHidden = content.classList.contains('hidden');
                        if (isHidden) {
                            if (content.innerHTML.trim() === '<!-- Report Content -->') { content.innerHTML = renderReportTable(data); setupReportInteraction(content, data); }
                            content.classList.remove('hidden');
                            icon.classList.add('rotate-180');
                        } else {
                            content.classList.add('hidden');
                            icon.classList.remove('rotate-180');
                        }
                    });
                    container.appendChild(itemDiv);
                });
            }
            
            async function findHistory() {
                const searchTerm = allDomElements.historySearchInput.value.trim().toLowerCase();
                if (!searchTerm) { alert("Please enter an order number to search."); return; }
                if (!db) { alert("History feature is unavailable. Database not connected."); return; }
                const originalBtnText = allDomElements.historySearchBtn.textContent;
                allDomElements.historySearchBtn.textContent = "Searching...";
                allDomElements.historySearchBtn.disabled = true;
                allDomElements.historyResults.innerHTML = `<div class="flex items-center gap-2 text-slate-600"><div class="loader !w-6 !h-6"></div>Searching archives...</div>`;
                try {
                    const historyQuery = query(getCollectionRef('comparisons'));
                    const querySnapshot = await getDocs(historyQuery);
                    const filteredDocs = [];
                    querySnapshot.forEach(doc => {
                         const data = doc.data();
                         const matchesBDO = data.bdoOrderNumber && String(data.bdoOrderNumber).toLowerCase().includes(searchTerm);
                         const matchesCust = data.customerOrderNumber?.customerValue && String(data.customerOrderNumber.customerValue).toLowerCase().includes(searchTerm);
                         if (matchesBDO || matchesCust) { filteredDocs.push({ id: doc.id, ...data }); }
                    });
                    if (filteredDocs.length === 0) {
                        allDomElements.historyResults.innerHTML = `<p class="text-slate-500 text-center py-2">No history found for: <strong>${searchTerm}</strong></p>`;
                        allDomElements.clearHistoryBtn.classList.remove('hidden');
                        return;
                    }
                    const latestComparisons = new Map();
                    filteredDocs.forEach(data => {
                        const orderNum = data.bdoOrderNumber || (data.customerOrderNumber ? data.customerOrderNumber.customerValue : null);
                        if (orderNum) {
                            const existing = latestComparisons.get(orderNum);
                            if (!existing || new Date(data.timestamp) > new Date(existing.timestamp)) { latestComparisons.set(orderNum, data); }
                        }
                    });
                    const finalResults = Array.from(latestComparisons.values()).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    renderHistoryList(finalResults, allDomElements.historyResults);
                    allDomElements.clearHistoryBtn.classList.remove('hidden');
                } catch (error) {
                    console.error("Error fetching history:", error);
                    allDomElements.historyResults.innerHTML = `<p class="text-red-500">Failed to fetch history.</p>`;
                } finally {
                    allDomElements.historySearchBtn.textContent = originalBtnText;
                    allDomElements.historySearchBtn.disabled = false;
                }
            }

            async function loadDailyHistory() {
                if (!db) return;
                allDomElements.dailyHistoryList.innerHTML = `<div class="flex items-center justify-center gap-2 text-slate-600 py-4"><div class="loader !w-6 !h-6"></div>Loading today's activity...</div>`;
                try {
                    const now = new Date();
                    const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).setHours(0,0,0,0);
                    const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).setHours(23,59,59,999);
                    const historyRef = getCollectionRef('comparisons'); 
                    const querySnapshot = await getDocs(historyRef);
                    const dailyItems = [];
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.timestamp) {
                            const itemTime = new Date(data.timestamp).getTime();
                            if (!isNaN(itemTime) && itemTime >= startOfDay && itemTime <= endOfDay) {
                                dailyItems.push({ id: doc.id, ...data });
                            }
                        }
                    });
                    dailyItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    renderHistoryList(dailyItems, allDomElements.dailyHistoryList);
                } catch (error) {
                    console.error("Error loading daily history:", error);
                    allDomElements.dailyHistoryList.innerHTML = `<p class="text-red-500 text-center py-4">Failed to load history. (Check console)</p>`;
                }
            }
            
            function setupDropZone(dropZone, fileInput, fileList, fileArray) {
                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
                dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files, fileList, fileArray); });
                fileInput.addEventListener('change', (e) => handleFiles(e.target.files, fileList, fileArray));
            }

            function handleFiles(files, fileListElem, fileArray) {
                fileArray.length = 0;
                [...files].forEach(file => { if (['application/pdf', 'image/jpeg', 'image/png'].includes(file.type)) { fileArray.push(file); } });
                updateFileList(fileListElem, fileArray);
                checkCompareButtonState();
            }

            function updateFileList(listElement, fileArray) {
                listElement.innerHTML = '';
                fileArray.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'file-item flex items-center justify-between bg-slate-100 p-2 rounded-md mt-2';
                    li.innerHTML = `<span class="text-sm text-slate-700 truncate">${file.name}</span> <span class="text-xs text-slate-500">${(file.size / 1024).toFixed(1)} KB</span>`;
                    listElement.appendChild(li);
                });
            }
            
            function checkCompareButtonState() {
                const allPairsValid = comparisonPairs.every(pair => pair.customerFiles.length > 0 && pair.blindIQFiles.length > 0);
                allDomElements.compareBtn.disabled = !allPairsValid;
            }
            
            function setupFabricDropZone() {
                const dropZone = allDomElements.fabricCsvDropZone;
                const fileInput = allDomElements.fabricCsvUpload;
                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over')); 
                dropZone.addEventListener('drop', (e) => { 
                    e.preventDefault(); 
                    dropZone.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        showConfirmModal("Replace all fabric properties?", () => processFabricFile(file));
                    }
                });
                fileInput.addEventListener('change', (e) => {
                     const file = e.target.files[0];
                     if (file) showConfirmModal("Replace all fabric properties?", () => processFabricFile(file));
                     e.target.value = '';
                });
            }
            
            function setupMotorDropZone() {
                const dropZone = allDomElements.motorCsvDropZone;
                const fileInput = allDomElements.motorCsvUpload;
                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over')); 
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        showConfirmModal("Replace all motor properties?", () => processMotorFile(file));
                    }
                });
                fileInput.addEventListener('change', (e) => {
                     const file = e.target.files[0];
                     if (file) showConfirmModal("Replace all motor properties?", () => processMotorFile(file));
                     e.target.value = '';
                });
            }
            
            function setupTubeDropZone() {
                const dropZone = allDomElements.tubeCsvDropZone;
                const fileInput = allDomElements.tubeCsvUpload;
                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        showConfirmModal("Replace all tube properties?", () => processTubeFile(file));
                    }
                });
                fileInput.addEventListener('change', (e) => {
                     const file = e.target.files[0];
                     if (file) showConfirmModal("Replace all tube properties?", () => processTubeFile(file));
                     e.target.value = '';
                });
            }
            
             function processFabricFile(file) {
                const listEl = allDomElements.fabricPropertiesList;
                listEl.innerHTML = `<div class="flex items-center justify-center gap-2 text-slate-600"><div class="loader !w-5 !h-5 !border-2"></div>Processing CSV...</div>`;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const parsedData = parseCsvAndExtractFabricData(text);
                    if (parsedData.length === 0) return;
                    
                    // Delete old
                    const q = query(getCollectionRef('fabric_properties'));
                    const oldDocs = await getDocs(q);
                    const deleteBatch = writeBatch(db);
                    oldDocs.forEach(doc => deleteBatch.delete(doc.ref));
                    await deleteBatch.commit();

                    // Add new
                    const addBatch = writeBatch(db);
                    parsedData.forEach(item => {
                        const ref = doc(getCollectionRef('fabric_properties'));
                        addBatch.set(ref, item);
                    });
                    await addBatch.commit();
                    loadAndDisplayFabricProperties();
                };
                reader.readAsText(file);
            }
            
             function processMotorFile(file) {
                const listEl = allDomElements.motorPropertiesList;
                listEl.innerHTML = `<div class="flex items-center justify-center gap-2 text-slate-600"><div class="loader !w-5 !h-5 !border-2"></div>Processing CSV...</div>`;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const parsedData = parseCsvAndExtractMotorData(text);
                    if (parsedData.length === 0) return;
                    const q = query(getCollectionRef('motor_properties'));
                    const oldDocs = await getDocs(q);
                    const deleteBatch = writeBatch(db);
                    oldDocs.forEach(doc => deleteBatch.delete(doc.ref));
                    await deleteBatch.commit();
                    const addBatch = writeBatch(db);
                    parsedData.forEach(item => {
                        const ref = doc(getCollectionRef('motor_properties'));
                        addBatch.set(ref, item);
                    });
                    await addBatch.commit();
                    loadAndDisplayMotorProperties();
                };
                reader.readAsText(file);
            }
            
            function processTubeFile(file) {
                 const listEl = allDomElements.tubePropertiesList;
                listEl.innerHTML = `<div class="flex items-center justify-center gap-2 text-slate-600"><div class="loader !w-5 !h-5 !border-2"></div>Processing CSV...</div>`;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const parsedData = parseCsvAndExtractTubeData(text);
                    if (parsedData.length === 0) return;
                    const q = query(getCollectionRef('tube_properties'));
                    const oldDocs = await getDocs(q);
                    const deleteBatch = writeBatch(db);
                    oldDocs.forEach(doc => deleteBatch.delete(doc.ref));
                    await deleteBatch.commit();
                    const addBatch = writeBatch(db);
                    parsedData.forEach(item => {
                        const ref = doc(getCollectionRef('tube_properties'));
                        addBatch.set(ref, item);
                    });
                    await addBatch.commit();
                    loadAndDisplayTubeProperties();
                };
                reader.readAsText(file);
            }
            
            // *** CSV Parsers ***
            function parseCsvAndExtractFabricData(text) {
                const rows = text.replace(/\r\n/g, '\n').split('\n').filter(row => row.trim() !== '');
                if (rows.length < 2) return [];
                const header = rows[0];
                const delimiter = header.includes(';') ? ';' : ',';
                const data = [];
                for (let i = 1; i < rows.length; i++) {
                    const rowText = rows[i];
                    if (!rowText.trim()) continue;
                    const columns = rowText.split(delimiter).map(cell => cell.trim().replace(/^"|"$/g, ''));
                    if (columns.length >= 4) {
                        const name = columns[0];
                        const weight = parseFloat(columns[1].replace(',', '.'));
                        const width = parseInt(columns[2], 10);
                        const canTurn = columns[3];
                        if (name && !isNaN(weight) && !isNaN(width) && canTurn) {
                            data.push({ fabricName: name, fabricWeight: weight, fabricWidth: width, canTurn: canTurn });
                        }
                    }
                }
                return data;
            }

            function parseCsvAndExtractMotorData(text) {
                const rows = text.replace(/\r\n/g, '\n').split('\n').filter(row => row.trim() !== '');
                if (rows.length < 2) return [];
                const header = rows[0];
                const delimiter = header.includes(';') ? ';' : ',';
                const data = [];
                for (let i = 1; i < rows.length; i++) {
                    const rowText = rows[i];
                    if (!rowText.trim()) continue;
                    const columns = rowText.match(new RegExp(`(\\${delimiter}|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\${delimiter}\\r\\n]*))`, 'gi'));
                    if (!columns) continue;
                    const cleanColumns = columns.map(col => {
                        let c = col.trim();
                        if (c.startsWith(delimiter)) c = c.substring(1);
                        if (c.startsWith('"') && c.endsWith('"')) c = c.substring(1, c.length - 1);
                        return c.replace(/""/g, '"');
                    });
                    if (cleanColumns.length >= 8) {
                        const [motorName, torqueStr, blindType, adapterKit, accessories, otherDependencies, blindControl, controlOptions] = cleanColumns;
                        const torque = parseFloat(torqueStr.replace(',', '.'));
                        if (motorName && !isNaN(torque) && blindType) {
                            data.push({ motorName, torque, blindType, adapterKit, accessories, otherDependencies, blindControl, controlOptions });
                        }
                    }
                }
                return data;
            }
            
             function parseCsvAndExtractTubeData(text) {
                const rows = text.replace(/\r\n/g, '\n').split('\n').filter(row => row.trim() !== '');
                if (rows.length < 2) return [];
                const header = rows[0];
                const delimiter = header.includes(';') ? ';' : ',';
                const data = [];
                for (let i = 1; i < rows.length; i++) {
                    const rowText = rows[i];
                    if (!rowText.trim()) continue;
                    const columns = rowText.split(delimiter).map(cell => cell.trim().replace(/^"|"$/g, ''));
                    if (columns.length >= 2) {
                        const blindType = columns[0];
                        const tubeDiameter = parseInt(columns[1], 10);
                        if (blindType && !isNaN(tubeDiameter)) {
                            data.push({ blindType, tubeDiameter });
                        }
                    }
                }
                return data;
            }
            
            // *** Loaders ***
             async function loadAndDisplayFabricProperties() {
                if (!db) return;
                const listEl = allDomElements.fabricPropertiesList;
                listEl.innerHTML = `<div class="flex items-center justify-center gap-2 text-slate-600"><div class="loader !w-5 !h-5 !border-2"></div>Loading fabrics...</div>`;
                const q = query(getCollectionRef('fabric_properties'));
                const snapshot = await getDocs(q);
                listEl.innerHTML = '';
                if (snapshot.empty) { listEl.innerHTML = '<p class="text-slate-400 italic text-center">No fabric properties loaded.</p>'; return; }
                snapshot.forEach(doc => renderFabricRow(doc.id, doc.data()));
            }
            
             async function loadAndDisplayMotorProperties() {
                 if (!db) return;
                 const listEl = allDomElements.motorPropertiesList;
                 const q = query(getCollectionRef('motor_properties'));
                 const snapshot = await getDocs(q);
                 listEl.innerHTML = '';
                 if(snapshot.empty) { listEl.innerHTML = '<p class="text-slate-400 italic text-center">No motor properties loaded.</p>'; return; }
                 snapshot.forEach(doc => {
                     renderMotorRow(doc.id, doc.data());
                 });
            }
            
            async function loadAndDisplayTubeProperties() {
                 if (!db) return;
                 const listEl = allDomElements.tubePropertiesList;
                 const q = query(getCollectionRef('tube_properties'));
                 const snapshot = await getDocs(q);
                 listEl.innerHTML = '';
                 if (snapshot.empty) { // <--- FIXED: Added curly braces
                    listEl.innerHTML = '<p class="text-slate-400 italic text-center">No tube properties loaded.</p>'; 
                    return;
                 }
                 snapshot.forEach(doc => {
                     renderTubeRow(doc.id, doc.data());
                 });
            }
            
            // *** Renderers ***
            function renderFabricRow(id, data, isNew = false) {
                const listEl = allDomElements.fabricPropertiesList;
                const fabricRow = document.createElement('div');
                fabricRow.className = 'fabric-row p-2 bg-slate-50 rounded-lg grid grid-cols-[1fr,auto,auto,auto,auto] items-center gap-2';
                fabricRow.dataset.id = id;
                fabricRow.innerHTML = `
                    <input type="text" value="${data.fabricName || ''}" placeholder="Fabric Name" class="fabric-name-input w-full p-1 border rounded text-sm font-semibold text-slate-800">
                    <div class="flex items-center gap-1"><label class="text-xs text-slate-500">Weight:</label><input type="number" step="0.001" value="${data.fabricWeight || ''}" class="fabric-weight-input w-20 p-1 border rounded text-sm"></div>
                    <div class="flex items-center gap-1"><label class="text-xs text-slate-500">Width:</label><input type="number" value="${data.fabricWidth || ''}" class="fabric-width-input w-20 p-1 border rounded text-sm"></div>
                    <div class="flex items-center gap-1"><label class="text-xs text-slate-500">Turn:</label><input type="text" value="${data.canTurn || ''}" placeholder="Yes/No/Out" class="fabric-turn-input w-20 p-1 border rounded text-sm"></div>
                    <div class="flex gap-2"><button class="save-fabric-btn bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded hover:bg-blue-600">${isNew ? 'Add' : 'Save'}</button>${isNew ? `<button class="cancel-new-fabric-btn bg-gray-200 text-gray-700 text-xs font-bold py-1 px-3 rounded hover:bg-gray-300">Cancel</button>` : `<button class="delete-fabric-btn text-red-400 hover:text-red-600 font-bold text-lg">&times;</button>`}</div>
                `;
                listEl.appendChild(fabricRow);

                fabricRow.querySelector('.save-fabric-btn').addEventListener('click', async () => {
                    const newName = fabricRow.querySelector('.fabric-name-input').value.trim();
                    const newWeight = parseFloat(fabricRow.querySelector('.fabric-weight-input').value);
                    const newWidth = parseInt(fabricRow.querySelector('.fabric-width-input').value, 10);
                    const newTurn = fabricRow.querySelector('.fabric-turn-input').value.trim();
                    if (!newName) return;
                    const dataToSave = { fabricName: newName, fabricWeight: newWeight, fabricWidth: newWidth, canTurn: newTurn };
                    if (isNew) await addDoc(getCollectionRef('fabric_properties'), dataToSave);
                    else await updateDoc(doc(getCollectionRef('fabric_properties'), id), dataToSave);
                    loadAndDisplayFabricProperties();
                });

                if (isNew) fabricRow.querySelector('.cancel-new-fabric-btn').addEventListener('click', () => fabricRow.remove());
                else fabricRow.querySelector('.delete-fabric-btn').addEventListener('click', () => {
                    showConfirmModal(`Delete "${data.fabricName}"?`, async () => {
                        await deleteDoc(doc(getCollectionRef('fabric_properties'), id));
                        loadAndDisplayFabricProperties();
                    });
                });
            }
            
            function renderMotorRow(id, data, isNew = false) {
                const listEl = allDomElements.motorPropertiesList;
                const motorRow = document.createElement('div');
                motorRow.className = 'motor-row p-2 bg-slate-50 rounded-lg grid grid-cols-[1fr,auto,1fr,1fr,1fr,1fr,1fr,1fr,auto] items-center gap-2';
                motorRow.dataset.id = id;
                motorRow.innerHTML = `
                    <input type="text" value="${data.motorName || ''}" placeholder="Motor Name" class="motor-name-input w-full p-1 border rounded text-sm font-semibold">
                    <input type="number" step="0.1" value="${data.torque || ''}" placeholder="Torque" class="motor-torque-input w-20 p-1 border rounded text-sm">
                    <input type="text" value="${data.blindType || ''}" placeholder="Blind Type" class="motor-blindtype-input w-full p-1 border rounded text-sm">
                    <input type="text" value="${data.adapterKit || ''}" placeholder="Adapter Kit" class="motor-adapter-input w-full p-1 border rounded text-sm">
                    <input type="text" value="${data.accessories || ''}" placeholder="Accessories" class="motor-accessories-input w-full p-1 border rounded text-sm">
                    <input type="text" value="${data.otherDependencies || ''}" placeholder="Other Dependencies" class="motor-dependencies-input w-full p-1 border rounded text-sm">
                    <input type="text" value="${data.blindControl || ''}" placeholder="Blind Control" class="motor-blindcontrol-input w-full p-1 border rounded text-sm">
                    <input type="text" value="${data.controlOptions || ''}" placeholder="Control, Options" class="motor-controls-input w-full p-1 border rounded text-sm">
                    <div class="flex gap-2"><button class="save-motor-btn bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded hover:bg-blue-600">${isNew ? 'Add' : 'Save'}</button>${isNew ? `<button class="cancel-new-motor-btn bg-gray-200 text-gray-700 text-xs font-bold py-1 px-3 rounded hover:bg-gray-300">Cancel</button>` : `<button class="delete-motor-btn text-red-400 hover:text-red-600 font-bold text-lg">&times;</button>`}</div>
                `;
                listEl.appendChild(motorRow);
                
                 motorRow.querySelector('.save-motor-btn').addEventListener('click', async () => {
                    const dataToSave = {
                        motorName: motorRow.querySelector('.motor-name-input').value.trim(),
                        torque: parseFloat(motorRow.querySelector('.motor-torque-input').value),
                        blindType: motorRow.querySelector('.motor-blindtype-input').value.trim(),
                        adapterKit: motorRow.querySelector('.motor-adapter-input').value.trim(),
                        accessories: motorRow.querySelector('.motor-accessories-input').value.trim(),
                        otherDependencies: motorRow.querySelector('.motor-dependencies-input').value.trim(),
                        blindControl: motorRow.querySelector('.motor-blindcontrol-input').value.trim(),
                        controlOptions: motorRow.querySelector('.motor-controls-input').value.trim()
                    };
                    if (!dataToSave.motorName) return;
                    if (isNew) await addDoc(getCollectionRef('motor_properties'), dataToSave);
                    else await updateDoc(doc(getCollectionRef('motor_properties'), id), dataToSave);
                    loadAndDisplayMotorProperties();
                 });
                 
                 if (!isNew) {
                     motorRow.querySelector('.delete-motor-btn').addEventListener('click', () => {
                        showConfirmModal("Delete motor?", async () => {
                             await deleteDoc(doc(getCollectionRef('motor_properties'), id));
                             loadAndDisplayMotorProperties();
                        });
                     });
                 } else {
                     motorRow.querySelector('.cancel-new-motor-btn').addEventListener('click', () => motorRow.remove());
                 }
            }

            function renderTubeRow(id, data, isNew = false) {
                const listEl = allDomElements.tubePropertiesList;
                const tubeRow = document.createElement('div');
                tubeRow.className = 'tube-row p-2 bg-slate-50 rounded-lg grid grid-cols-[1fr,auto,auto] items-center gap-2';
                tubeRow.dataset.id = id;
                tubeRow.innerHTML = `
                    <input type="text" value="${data.blindType || ''}" placeholder="Blind Type" class="tube-blindtype-input w-full p-1 border rounded text-sm font-semibold">
                    <input type="number" value="${data.tubeDiameter || ''}" placeholder="Diameter (mm)" class="tube-diameter-input w-32 p-1 border rounded text-sm">
                    <div class="flex gap-2"><button class="save-tube-btn bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded hover:bg-blue-600">${isNew ? 'Add' : 'Save'}</button>${isNew ? `<button class="cancel-new-tube-btn bg-gray-200 text-gray-700 text-xs font-bold py-1 px-3 rounded hover:bg-gray-300">Cancel</button>` : `<button class="delete-tube-btn text-red-400 hover:text-red-600 font-bold text-lg">&times;</button>`}</div>
                `;
                listEl.appendChild(tubeRow);

                tubeRow.querySelector('.save-tube-btn').addEventListener('click', async () => {
                     const dataToSave = {
                        blindType: tubeRow.querySelector('.tube-blindtype-input').value.trim(),
                        tubeDiameter: parseInt(tubeRow.querySelector('.tube-diameter-input').value, 10),
                    };
                    if (!dataToSave.blindType) return;
                    if (isNew) await addDoc(getCollectionRef('tube_properties'), dataToSave);
                    else await updateDoc(doc(getCollectionRef('tube_properties'), id), dataToSave);
                    loadAndDisplayTubeProperties();
                });
                 
                 if (!isNew) {
                     tubeRow.querySelector('.delete-tube-btn').addEventListener('click', () => {
                        showConfirmModal("Delete tube?", async () => {
                             await deleteDoc(doc(getCollectionRef('tube_properties'), id));
                             loadAndDisplayTubeProperties();
                        });
                     });
                 } else {
                     tubeRow.querySelector('.cancel-new-tube-btn').addEventListener('click', () => tubeRow.remove());
                 }
            }
            
            async function getFabricProperties() {
                if (!db) return new Map();
                const propertiesRef = getCollectionRef('fabric_properties');
                const snapshot = await getDocs(propertiesRef);
                const fabricMap = new Map();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    fabricMap.set(data.fabricName.toLowerCase().trim(), data);
                });
                return fabricMap;
            }
            
            async function getMotorProperties() {
                if (!db) return [];
                const propertiesRef = getCollectionRef('motor_properties');
                const snapshot = await getDocs(propertiesRef);
                const motorList = [];
                 snapshot.forEach(doc => {
                    motorList.push(doc.data());
                });
                return motorList;
            }
            
            async function getTubeProperties() {
                if (!db) return new Map();
                const propertiesRef = getCollectionRef('tube_properties');
                const snapshot = await getDocs(propertiesRef);
                const tubeMap = new Map();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tubeMap.set(data.blindType.toLowerCase().trim(), data);
                });
                return tubeMap;
            }
            
            async function runAllComparisons() {
                allDomElements.uploadSection.classList.add('hidden');
                allDomElements.reportSection.classList.remove('hidden');
                allDomElements.newComparisonBtn.classList.add('hidden');
                allDomElements.reportContent.innerHTML = `<div class="flex flex-col items-center justify-center p-8"><div class="loader"></div><p id="batch-status" class="mt-4 text-slate-600 font-semibold">Starting batch comparison...</p></div>`;
                
                const batchStatus = document.getElementById('batch-status');
                summaryResultsCache = [];
                let failedPairs = [];
    
                // Fetch properties once for the whole batch
                batchStatus.textContent = 'Fetching properties...';
                const [fabricProperties, motorProperties, tubeProperties] = await Promise.all([
                    getFabricProperties(),
                    getMotorProperties(),
                    getTubeProperties()
                ]);
    
                for (let i = 0; i < comparisonPairs.length; i++) {
                    batchStatus.textContent = `Processing order ${i + 1} of ${comparisonPairs.length}...`;
                    try {
                        let result = await processSingleComparison(comparisonPairs[i]);
                        result = runPostAIValidations(result, fabricProperties, motorProperties, tubeProperties);
                        summaryResultsCache.push({ status: 'success', data: result });
                    } catch (error) {
                        console.error(`Failed comparison for pair ${i}:`, error);
                        summaryResultsCache.push({ status: 'failed', error: error.message, orderNumber: `Pair ${i+1}` });
                        failedPairs.push({pair: comparisonPairs[i], originalIndex: i});
                    }
                }
    
                if (failedPairs.length > 0) {
                     batchStatus.textContent = `Retrying ${failedPairs.length} failed orders...`;
                     for (let i = 0; i < failedPairs.length; i++) {
                         try {
                             let result = await processSingleComparison(failedPairs[i].pair);
                             result = runPostAIValidations(result, fabricProperties, motorProperties, tubeProperties);
                             summaryResultsCache[failedPairs[i].originalIndex] = { status: 'success', data: result };
                         } catch (error) {
                             console.error(`Retry failed for pair ${failedPairs[i].originalIndex}:`, error);
                         }
                     }
                }
    
                batchStatus.textContent = 'All comparisons complete.';
                renderSummaryReport(summaryResultsCache);
                allDomElements.newComparisonBtn.classList.remove('hidden');
            }
            
            function resetUI() {
                allDomElements.uploadSection.classList.remove('hidden');
                allDomElements.reportSection.classList.add('hidden');
                allDomElements.newComparisonBtn.classList.add('hidden');
                allDomElements.clearHistoryBtn.classList.add('hidden');
                allDomElements.historyResults.innerHTML = '';
                allDomElements.historySearchInput.value = '';
                comparisonPairs = [];
                allDomElements.uploadPairsContainer.innerHTML = '';
                addNewPair();
                checkCompareButtonState();
            }
            
            // ==========================================
            // 2. EVENT LISTENERS
            // ==========================================
            
            allDomElements.addPairBtn.addEventListener('click', addNewPair);
            allDomElements.historySearchBtn.addEventListener('click', findHistory);
            allDomElements.historySearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); findHistory(); } });
            allDomElements.compareBtn.addEventListener('click', runAllComparisons);
            allDomElements.newComparisonBtn.addEventListener('click', resetUI);
            allDomElements.clearHistoryBtn.addEventListener('click', () => {
                allDomElements.historyResults.innerHTML = '';
                allDomElements.historySearchInput.value = '';
                allDomElements.clearHistoryBtn.classList.add('hidden');
            });
            
            // Tabs
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    const targetPanel = document.getElementById(targetId);
                    const isActive = button.classList.contains('active-tab');
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active-tab'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    if (!isActive && targetPanel) {
                        button.classList.add('active-tab');
                        targetPanel.classList.remove('hidden');
                    }
                });
            });
            
            // Cancel Feedback Modal
             allDomElements.cancelFeedbackBtn.addEventListener('click', () => {
                 allDomElements.feedbackModal.style.display = 'none';
                 allDomElements.feedbackExplanation.value = '';
                 pastedImageB64 = null;
                 allDomElements.feedbackImageContainer.classList.add('hidden');
                 allDomElements.feedbackImagePreview.src = '';
                 allDomElements.feedbackExplanation.style.paddingLeft = '0.5rem';
            });
            
             // Submit Feedback
            allDomElements.submitFeedbackBtn.addEventListener('click', async () => {
                if (!itemToCorrect || !allDomElements.feedbackExplanation.value.trim()) { alert("Please provide an explanation."); return; }
                allDomElements.submitFeedbackBtn.disabled = true;
                allDomElements.submitFeedbackBtn.innerHTML = `<div class="loader !w-5 !h-5 !border-2 mx-auto"></div>`;
    
                try {
                    const enhancementPrompt = `You are an expert prompt engineer. A user has provided a guideline for an AI document comparison tool. Rewrite their text into a clear, precise, and unambiguous rule that the AI can easily follow. User's text: "${allDomElements.feedbackExplanation.value.trim()}"`;
                    const enhancementParts = [{ text: enhancementPrompt }];
                    if (pastedImageB64) { enhancementParts.push({ inlineData: { mimeType: 'image/png', data: pastedImageB64.split(',')[1] } }); }
    
                    const geminiPayload = { contents: [{ role: "user", parts: enhancementParts }] };
                    const proxyPayload = { model: 'gemini-2.5-flash', payload: geminiPayload };
                    
                    const response = await fetch(PROXY_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(proxyPayload) });
                    if (!response.ok) throw new Error('Failed to enhance explanation.');
                    
                    const result = await response.json();
                    const enhancedExplanation = result.candidates[0].content.parts[0].text;
    
                    const feedbackData = { 
                        userId: userId, 
                        timestamp: new Date().toISOString(), 
                        incorrectItem: itemToCorrect, 
                        userExplanation: allDomElements.feedbackExplanation.value.trim(), 
                        enhancedExplanation: enhancedExplanation,
                    };
                    if (pastedImageB64) { feedbackData.imageSnippet = pastedImageB64; }
    
                    await addDoc(getCollectionRef('feedback'), feedbackData);
                    allDomElements.cancelFeedbackBtn.click();
                } catch (error) { 
                    console.error("Error submitting feedback: ", error); 
                    alert("Failed to submit feedback. The original explanation will be saved.");
                    const fallbackData = { 
                        userId: userId, 
                        timestamp: new Date().toISOString(), 
                        incorrectItem: itemToCorrect, 
                        userExplanation: allDomElements.feedbackExplanation.value.trim(), 
                        enhancedExplanation: `RAW: ${allDomElements.feedbackExplanation.value.trim()}`,
                    };
                    if (pastedImageB64) { fallbackData.imageSnippet = pastedImageB64; }
                    await addDoc(getCollectionRef('feedback'), fallbackData);
                    allDomElements.cancelFeedbackBtn.click();
                } finally { 
                    allDomElements.submitFeedbackBtn.disabled = false; 
                    allDomElements.submitFeedbackBtn.textContent = 'Submit Feedback'; 
                }
            });
            
            allDomElements.feedbackTextareaContainer.addEventListener('paste', (event) => {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                for (const item of items) {
                    if (item.kind === 'file') {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            pastedImageB64 = e.target.result;
                            allDomElements.feedbackImagePreview.src = pastedImageB64;
                            allDomElements.feedbackImageContainer.classList.remove('hidden');
                            allDomElements.feedbackExplanation.style.paddingLeft = '72px'; // Make space for the image
                        };
                        reader.readAsDataURL(blob);
                        event.preventDefault();
                    }
                }
            });
    
            allDomElements.feedbackImageDelete.addEventListener('click', () => {
                pastedImageB64 = null;
                allDomElements.feedbackImageContainer.classList.add('hidden');
                allDomElements.feedbackImagePreview.src = '';
                allDomElements.feedbackExplanation.style.paddingLeft = '0.5rem';
            });


            // Dropzones for Properties
            // Using the functions defined above
            setupFabricDropZone();
            setupMotorDropZone();
            setupTubeDropZone();

            // ==========================================
            // 3. INITIALIZATION
            // ==========================================
            
            addNewPair();
            loadAndDisplayGuidelines();
            loadAndDisplayFabricProperties();
            loadAndDisplayMotorProperties();
            loadAndDisplayTubeProperties();
            loadDailyHistory();
        });
    </script>
</body>
</html>
